1
00:00:17,667 --> 00:00:21,967
大家好 欢迎来到

2
00:00:22,067 --> 00:00:24,033
“HTTP实时流

3
00:00:24,667 --> 00:00:28,933
我是Shravya Kunamalla

4
00:00:29,700 --> 00:00:30,867
让我们开始

5
00:00:32,800 --> 00:00:36,233
很多应用开发者使用我们广受欢迎的

6
00:00:36,300 --> 00:00:39,500
进行媒体流传输

7
00:00:40,100 --> 00:00:41,167
在过去几年里

8
00:00:41,233 --> 00:00:45,733
这项应用已经演变成为

9
00:00:46,200 --> 00:00:49,500
开发人员进行实时活动直播

10
00:00:49,567 --> 00:00:51,067
和预录视频直播

11
00:00:51,467 --> 00:00:55,700
它们提供多种不同的媒体选择

12
00:00:56,100 --> 00:00:57,967
使用可变比特率

13
00:00:58,033 --> 00:01:00,967
不同的声音和语言字幕

14
00:00:58,033 --> 00:01:00,967
不同的声音和语言字幕

15
00:01:01,300 --> 00:01:03,667
内容本身可能受到保护

16
00:01:03,733 --> 00:01:07,667
可能同时有数百万在线观众

17
00:01:07,733 --> 00:01:09,633
订阅你的流媒体

18
00:01:10,100 --> 00:01:14,100
由于工作负荷巨大

19
00:01:14,967 --> 00:01:17,700
过去多年里

20
00:01:17,767 --> 00:01:21,233
许多开发者和内容提供商

21
00:01:21,433 --> 00:01:24,867
“当发生错误时

22
00:01:25,567 --> 00:01:27,100
为了解答这个问题

23
00:01:27,167 --> 00:01:31,200
今天我们将会介绍

24
00:01:31,267 --> 00:01:34,000
包括在应用端和服务器端

25
00:01:36,233 --> 00:01:40,533
参加本演讲的人

26
00:01:40,600 --> 00:01:42,667
让我们进行简要回顾

27
00:01:43,500 --> 00:01:44,933
我们需要一个主播放列表

28
00:01:45,000 --> 00:01:48,700
含有相同内容的不同版本

29
00:01:49,267 --> 00:01:50,567
在本例中

30
00:01:50,633 --> 00:01:53,600
有6MB和2MB视频

31
00:01:54,400 --> 00:01:56,200
英语和法语音频

32
00:01:57,100 --> 00:01:59,500
英语和法语字幕

33
00:02:00,233 --> 00:02:05,500
它们调用一个媒体播放列表

34
00:02:06,933 --> 00:02:09,667
媒体列表包含几个片段

35
00:02:09,967 --> 00:02:10,967
在实际播放中

36
00:02:11,032 --> 00:02:15,533
会在获取播放列表时

37
00:02:15,933 --> 00:02:18,233
这些片段可能会从头开始

38
00:02:18,300 --> 00:02:20,667
新片段被添加到末尾

39
00:02:22,333 --> 00:02:26,900
如果片段受到保护

40
00:02:28,533 --> 00:02:30,667
另外还有会话数据

41
00:02:30,867 --> 00:02:34,533
例如标题或歌词

42
00:02:35,967 --> 00:02:39,567
服务器将发送这些资源

43
00:02:39,767 --> 00:02:42,967
HLS客户端需要它们来进行回放

44
00:02:44,800 --> 00:02:48,967
如果发生错误而导致服务器

45
00:02:49,233 --> 00:02:54,267
处理内容和传输错误

46
00:02:56,333 --> 00:03:00,133
许多iOS

47
00:02:56,333 --> 00:03:00,133
许多iOS

48
00:03:00,200 --> 00:03:02,600
需要从服务器接收这些资源

49
00:03:03,000 --> 00:03:06,500
服务器应该及时交付这些资源

50
00:03:06,633 --> 00:03:08,267
如果交付失败

51
00:03:08,333 --> 00:03:11,433
将会发送相应的

52
00:03:11,867 --> 00:03:15,767
此错误代码应该

53
00:03:16,100 --> 00:03:18,100
比如 请求无效

54
00:03:18,300 --> 00:03:19,667
未获得授权

55
00:03:19,900 --> 00:03:22,000
或服务器遇到错误等

56
00:03:22,433 --> 00:03:25,267
比如 由于不支持功能请求

57
00:03:25,333 --> 00:03:28,633
服务器无法执行请求

58
00:03:29,967 --> 00:03:32,433
接下来 让我们来看一些推荐方法

59
00:03:32,500 --> 00:03:35,500
它们用于发送

60
00:03:36,700 --> 00:03:40,667
这是一个故障和

61
00:03:41,133 --> 00:03:44,700
它们是RFC7231中规定的

62
00:03:44,767 --> 00:03:47,833
标准HTTP错误代码

63
00:03:48,700 --> 00:03:54,467
如果片段受到保护

64
00:03:54,967 --> 00:03:56,200
将发送401代码

65
00:03:57,833 --> 00:04:00,967
如果客户端没有获得内容授权

66
00:03:57,833 --> 00:04:00,967
如果客户端没有获得内容授权

67
00:04:01,733 --> 00:04:03,233
将发送403代码

68
00:04:04,567 --> 00:04:08,733
如果临时资源无法使用

69
00:04:09,400 --> 00:04:10,667
将发送404代码

70
00:04:13,133 --> 00:04:15,467
对于永久性资源不可用

71
00:04:15,833 --> 00:04:17,000
将发送410

72
00:04:18,500 --> 00:04:23,100
对于所有异常服务器状况

73
00:04:23,367 --> 00:04:24,700
将发送500代码

74
00:04:25,900 --> 00:04:29,900
大多数内容提供者

75
00:04:29,967 --> 00:04:33,567
它们从其它位置的编码器

76
00:04:34,067 --> 00:04:38,933
通知网关的无效响应

77
00:04:40,700 --> 00:04:44,033
如果服务器处于维护停机

78
00:04:44,100 --> 00:04:46,233
或因其它任何原因不可用

79
00:04:47,000 --> 00:04:48,267
将发送503代码

80
00:04:50,000 --> 00:04:53,467
对于网关超时 将发送504代码

81
00:04:54,833 --> 00:04:57,133
这些错误代码并是新代码

82
00:04:57,200 --> 00:04:58,933
它们已经被沿用很长时间

83
00:04:59,200 --> 00:05:01,233
如果研究这些错误

84
00:04:59,200 --> 00:05:01,233
如果研究这些错误

85
00:05:01,300 --> 00:05:04,133
可以发现

86
00:05:04,200 --> 00:05:07,433
比如资源和

87
00:05:08,067 --> 00:05:09,733
从iOS 11开始

88
00:05:10,033 --> 00:05:11,167
我们提供一种方法

89
00:05:11,233 --> 00:05:15,467
使用GAP标记

90
00:05:16,167 --> 00:05:18,900
通知给AVPlayer

91
00:05:19,567 --> 00:05:24,100
我们使用EXT-X-GAP

92
00:05:24,667 --> 00:05:27,500
这可以应用于

93
00:05:28,700 --> 00:05:31,367
将此标记放入播放列表 以指示GAP

94
00:05:31,433 --> 00:05:34,433
使AVPlayer能够

95
00:05:36,200 --> 00:05:40,533
看到此标记后 AVPlayer

96
00:05:40,600 --> 00:05:44,667
可能会决定转向备用内容

97
00:05:45,700 --> 00:05:47,700
如果没有可用内容

98
00:05:47,767 --> 00:05:51,733
AVPlayer最终可能会

99
00:05:51,800 --> 00:05:54,600
直到错误状态结束并恢复正常

100
00:05:57,067 --> 00:05:59,767
让我们回到故障和错误代码

101
00:06:00,267 --> 00:06:03,367
对于适合使用GAP标记

102
00:06:04,600 --> 00:06:07,633
404临时资源不可用

103
00:06:08,133 --> 00:06:12,500
和503服务器不可用

104
00:06:12,833 --> 00:06:15,967
请记住 此标记适用于

105
00:06:16,033 --> 00:06:17,667
实时流媒体和[听不清]回放

106
00:06:17,733 --> 00:06:21,067
但是典型应用一般是实时流媒体

107
00:06:21,700 --> 00:06:26,100
接下来我们将讨论HLS媒体错误情况

108
00:06:27,300 --> 00:06:28,667
当在线回放时

109
00:06:28,733 --> 00:06:35,067
HLS包指定需要定期更新的播放列表

110
00:06:35,600 --> 00:06:38,500
如果服务器无法及时

111
00:06:38,567 --> 00:06:41,267
根据发布的目标持续时间

112
00:06:41,333 --> 00:06:45,067
我们建议通过发送404代码

113
00:06:45,133 --> 00:06:46,700
向AVPlayer

114
00:06:47,667 --> 00:06:50,800
可以返回过时的播放列表本身

115
00:06:50,867 --> 00:06:55,667
但是这需要AVplayer

116
00:06:55,867 --> 00:06:57,200
分析过时的播放列表

117
00:06:57,667 --> 00:06:59,333
在分析时

118
00:06:59,400 --> 00:07:03,867
AVPlayer将会尝试各种方法

119
00:06:59,400 --> 00:07:03,867
AVPlayer将会尝试各种方法

120
00:07:03,933 --> 00:07:05,233
或者重试

121
00:07:06,000 --> 00:07:09,733
有些情况下 这可能会用时过长

122
00:07:10,600 --> 00:07:12,333
相比之下 发送404 代码

123
00:07:12,400 --> 00:07:16,467
能够更快地将过时播放列表

124
00:07:17,267 --> 00:07:19,233
这里有另外一个好处

125
00:07:19,633 --> 00:07:23,233
这会立即将过时播放列表

126
00:07:23,300 --> 00:07:26,133
通知给正在加入流媒体的

127
00:07:28,800 --> 00:07:33,100
对于不支持的特性 比如

128
00:07:33,167 --> 00:07:34,400
则发送501代码

129
00:07:35,533 --> 00:07:39,333
对于所有身份验证失败

130
00:07:42,900 --> 00:07:47,600
接下来我们看一个典型的实时回放例子

131
00:07:48,033 --> 00:07:50,133
我们有两个视频版本

132
00:07:50,200 --> 00:07:53,133
分别为6MB和2MB

133
00:07:53,600 --> 00:07:56,433
还有相应的编码器/包装器

134
00:07:56,500 --> 00:07:58,433
一个提供6MB视频

135
00:07:58,500 --> 00:08:01,667
另一个为服务器提供2MB视频

136
00:07:58,500 --> 00:08:01,667
另一个为服务器提供2MB视频

137
00:08:01,900 --> 00:08:06,833
服务器分发这个内容至

138
00:08:07,300 --> 00:08:09,433
假设网络带宽

139
00:08:09,500 --> 00:08:12,633
足够传输6MB视频

140
00:08:12,933 --> 00:08:16,500
将会获取6MB媒体播放列表

141
00:08:16,733 --> 00:08:18,367
获得应答

142
00:08:18,433 --> 00:08:21,800
然后获取第一个片段

143
00:08:22,400 --> 00:08:24,533
到目前为止 一切正常

144
00:08:25,667 --> 00:08:29,667
突然6MB编码器

145
00:08:29,733 --> 00:08:32,299
长时间停止运行

146
00:08:33,067 --> 00:08:36,400
接下来AVPlayer

147
00:08:36,500 --> 00:08:40,000
服务器将故障信息发送给

148
00:08:40,600 --> 00:08:41,567
使用GAP标记

149
00:08:41,933 --> 00:08:43,667
对于这个重获取请求

150
00:08:43,732 --> 00:08:47,767
建议服务器发送200 okay代码

151
00:08:47,833 --> 00:08:50,667
媒体播放器中的后续片段

152
00:08:50,733 --> 00:08:52,300
应标记为GAP

153
00:08:53,367 --> 00:08:58,400
AVPlayer在看到这个GAP标记后

154
00:08:58,667 --> 00:09:00,867
获取相应的媒体播放列表

155
00:08:58,667 --> 00:09:00,867
获取相应的媒体播放列表

156
00:09:00,933 --> 00:09:03,300
继续获取下一个片段

157
00:09:03,367 --> 00:09:06,033
即2MB版本的片段2

158
00:09:07,433 --> 00:09:12,500
这样 可以及时和平滑地切换

159
00:09:14,233 --> 00:09:19,133
为了保持向后兼容

160
00:09:19,200 --> 00:09:21,567
服务器仍然发送404代码

161
00:09:25,833 --> 00:09:28,167
接下来 我们来看失效转移

162
00:09:28,833 --> 00:09:30,067
什么是失效转移？

163
00:09:30,733 --> 00:09:33,900
它是指主系统发生故障时

164
00:09:33,967 --> 00:09:39,833
待机或备用系统接管工作

165
00:09:41,400 --> 00:09:43,767
我们的服务器提供什么样的失效转移？

166
00:09:44,367 --> 00:09:49,633
一种方法是在备用服务器上

167
00:09:50,567 --> 00:09:53,733
将具有相同比特率的

168
00:09:53,800 --> 00:09:56,233
并把它们加入到主播放列表之中

169
00:09:56,767 --> 00:10:01,967
当发生错误时 AVPlayer

170
00:09:56,767 --> 00:10:01,967
当发生错误时 AVPlayer

171
00:10:02,967 --> 00:10:06,800
在切换到停机状态之前

172
00:10:09,500 --> 00:10:12,700
如果服务器想要显式地触发失效转移

173
00:10:12,767 --> 00:10:15,900
应该发送404代码给列表请求

174
00:10:19,567 --> 00:10:25,500
总之 始终应该使用正确的错误代码

175
00:10:26,467 --> 00:10:31,833
将备用播放列表存放在不同服务器

176
00:10:31,900 --> 00:10:33,800
这种冗余配置是正确的做法

177
00:10:35,233 --> 00:10:38,233
对于不支持的功能 应发送501代码

178
00:10:39,800 --> 00:10:41,333
在实时流媒体应用中

179
00:10:41,833 --> 00:10:45,733
应按照HLS规范及时更新播放列表

180
00:10:47,233 --> 00:10:50,433
对于临时故障 应优先使用GAP标记

181
00:10:51,767 --> 00:10:55,467
应发送404代码指示过时播放列表

182
00:11:00,133 --> 00:11:05,033
现在我们讨论如何处理

183
00:11:05,600 --> 00:11:06,733
发生错误时

184
00:11:06,800 --> 00:11:10,500
正在观看流媒体的用户

185
00:11:10,867 --> 00:11:12,833
首先 应该知道发生了错误

186
00:11:12,900 --> 00:11:15,733
其次 需要知道

187
00:11:16,633 --> 00:11:19,933
并且预测服务器上的所有错误

188
00:11:20,700 --> 00:11:23,367
应返回AVFoundation

189
00:11:23,433 --> 00:11:27,933
以及时地响应

190
00:11:28,000 --> 00:11:29,833
各种错误状况

191
00:11:31,000 --> 00:11:33,000
但是 我们如何确定错误呢？

192
00:11:34,400 --> 00:11:38,933
可通过查看AVPlayer.status

193
00:11:39,000 --> 00:11:41,267
来确定错误

194
00:11:42,300 --> 00:11:45,833
它们将会分别变更为

195
00:11:45,900 --> 00:11:49,100
和AVPlayerItemStatusFailed

196
00:11:49,167 --> 00:11:50,000
以显示错误状态

197
00:11:52,133 --> 00:11:56,100
要想知道导致故障状态的错误

198
00:11:56,333 --> 00:11:58,700
应查看AVPlayerItem.error

199
00:11:59,733 --> 00:12:03,900
它描述是什么原因

200
00:11:59,733 --> 00:12:03,900
它描述是什么原因

201
00:12:07,300 --> 00:12:11,933
侦听AVPlayerItemFailed

202
00:12:12,000 --> 00:12:15,200
以获得内容没有播放结束这一通知

203
00:12:17,200 --> 00:12:20,200
此通知的用户信息字典

204
00:12:20,267 --> 00:12:23,333
包含一个错误对象

205
00:12:23,400 --> 00:12:25,167
可以通过

206
00:12:25,233 --> 00:12:29,167
AVPlayerItemFailedToPlay

207
00:12:32,567 --> 00:12:36,533
让我们来更深入探究

208
00:12:37,533 --> 00:12:40,433
此日志记录

209
00:12:40,500 --> 00:12:42,800
所有错误事件

210
00:12:45,467 --> 00:12:47,133
那么 这些错误意味着什么？

211
00:12:49,433 --> 00:12:51,633
它们可能意味着以下四种情况之一：

212
00:12:52,067 --> 00:12:58,000
网络错误、超时、格式错误

213
00:12:58,967 --> 00:13:03,967
网络错误代码是4xx

214
00:12:58,967 --> 00:13:03,967
网络错误代码是4xx

215
00:13:04,033 --> 00:13:07,067
和TCP/IP、DNS错误

216
00:13:08,867 --> 00:13:10,600
请求资源之后

217
00:13:10,667 --> 00:13:14,700
主播放列表、媒体播放列表

218
00:13:14,767 --> 00:13:16,767
媒体文件和密钥可能发生超时错误

219
00:13:17,100 --> 00:13:19,967
无法及时取得回应

220
00:13:20,033 --> 00:13:21,933
将会导致超时错误

221
00:13:25,200 --> 00:13:29,667
不正确的播放列表密钥

222
00:13:29,733 --> 00:13:31,800
会导致格式错误

223
00:13:33,700 --> 00:13:35,100
在实时流媒体中

224
00:13:35,333 --> 00:13:38,867
需要根据发布的目标持续时间

225
00:13:38,933 --> 00:13:43,500
如果未能这样做

226
00:13:47,400 --> 00:13:51,100
相应地

227
00:13:52,167 --> 00:13:54,367
对于网络错误和超时

228
00:13:54,433 --> 00:13:57,567
错误代码是

229
00:13:57,633 --> 00:14:00,433
或AVErrorNoLongerPlayable

230
00:13:57,633 --> 00:14:00,433
或AVErrorNoLongerPlayable

231
00:14:01,567 --> 00:14:06,700
AVErrorContentIsUnavailable表示

232
00:14:06,967 --> 00:14:11,367
这意味着身份验证失败

233
00:14:12,367 --> 00:14:17,100
AVErrorNoLongerPlayable

234
00:14:17,167 --> 00:14:20,400
在播放过程中

235
00:14:20,467 --> 00:14:23,300
造成无法继续播放

236
00:14:25,767 --> 00:14:29,467
AVErrorFailedToParse

237
00:14:31,267 --> 00:14:37,067
AVErrorContentNotUpdated表示

238
00:14:40,333 --> 00:14:44,700
应查看错误的用户信息

239
00:14:45,167 --> 00:14:46,000
请记住

240
00:14:46,067 --> 00:14:50,200
如果多个错误造成项目失效

241
00:14:52,300 --> 00:14:55,467
新错误日志条目

242
00:14:55,833 --> 00:14:59,900
将发送AVPlayerItem

243
00:15:00,300 --> 00:15:03,533
因此应该侦听此通知

244
00:15:05,067 --> 00:15:07,433
这里我要强调一点

245
00:15:08,067 --> 00:15:13,100
AVPlayer将会努力尝试

246
00:15:13,167 --> 00:15:16,200
切换到不同的可用视频版本

247
00:15:16,400 --> 00:15:19,567
只有不存在可继续回放的视频版本

248
00:15:19,633 --> 00:15:24,200
而且已经播放完缓存内容时

249
00:15:24,267 --> 00:15:27,233
AVPlayerItem.status

250
00:15:29,233 --> 00:15:31,067
对于所有临时错误

251
00:15:31,300 --> 00:15:35,467
AVPlayer将会

252
00:15:35,900 --> 00:15:38,100
如果可以切换到其它视频版本

253
00:15:38,167 --> 00:15:41,433
AVPlayer将会重试一定时间

254
00:15:41,500 --> 00:15:42,733
只有失败后才会放弃

255
00:15:43,700 --> 00:15:45,500
在一定时间之后

256
00:15:45,567 --> 00:15:48,667
将会尝试从备用版本

257
00:15:48,733 --> 00:15:50,900
如果网络状况合适

258
00:15:52,000 --> 00:15:56,433
对于永久性错误 例如410

259
00:15:56,500 --> 00:16:00,167
AVPlayer仅尝试

260
00:15:56,500 --> 00:16:00,167
AVPlayer仅尝试

261
00:16:01,533 --> 00:16:04,133
永久和临时错误代码

262
00:16:04,200 --> 00:16:10,867
符合RFC7231规定的

263
00:16:13,500 --> 00:16:17,633
所有会话数据错误

264
00:16:21,667 --> 00:16:24,367
接下来 我们来看代码片段

265
00:16:25,200 --> 00:16:28,133
要查看错误

266
00:16:28,200 --> 00:16:30,967
创建你的资产

267
00:16:31,033 --> 00:16:32,967
使用项目创建播放器

268
00:16:33,267 --> 00:16:38,500
首先要做的是添加侦察器

269
00:16:41,167 --> 00:16:45,800
然后添加侦察器

270
00:16:48,433 --> 00:16:51,700
这里你注册并侦听

271
00:16:51,767 --> 00:16:55,567
AVPlayerItemFailed

272
00:16:59,100 --> 00:17:02,600
在获得通知之后

273
00:16:59,100 --> 00:17:02,600
在获得通知之后

274
00:17:03,133 --> 00:17:06,933
AVPlayerItem.error

275
00:17:07,532 --> 00:17:09,833
在这里

276
00:17:09,900 --> 00:17:13,300
向用户显示相关的错误信息

277
00:17:15,933 --> 00:17:20,233
获取AVPlayerItemFailed

278
00:17:20,400 --> 00:17:26,233
提取错误值AVPlayerItem

279
00:17:26,666 --> 00:17:28,933
然后 采取合适的操作

280
00:17:29,000 --> 00:17:29,833
例如

281
00:17:29,900 --> 00:17:33,333
打印错误或显示相关的错误信息

282
00:17:38,367 --> 00:17:39,367
总结

283
00:17:39,633 --> 00:17:43,733
应始终监测

284
00:17:44,567 --> 00:17:46,233
侦听通知

285
00:17:46,300 --> 00:17:49,533
AVPlayerItemFailed

286
00:17:49,600 --> 00:17:52,167
告知用户内容没有播放结束

287
00:17:52,600 --> 00:17:55,000
如果你想要更主动地监测错误

288
00:17:55,067 --> 00:18:00,133
例如 发送调试信息

289
00:17:55,067 --> 00:18:00,133
例如 发送调试信息

290
00:18:00,200 --> 00:18:04,500
应侦听AVPlayerItem

291
00:18:04,567 --> 00:18:06,700
以获知

292
00:18:07,700 --> 00:18:08,967
总之

293
00:18:09,033 --> 00:18:10,433
当发生错误时

294
00:18:10,867 --> 00:18:14,367
应该采取合适的措施

295
00:18:14,733 --> 00:18:16,733
应该向用户通知错误

296
00:18:16,800 --> 00:18:22,200
在合适情况下

297
00:18:24,767 --> 00:18:25,967
更多信息

298
00:18:26,033 --> 00:18:30,800
请访问WWDC网站

299
00:18:32,133 --> 00:18:34,467
谢谢并祝大家大会愉快
