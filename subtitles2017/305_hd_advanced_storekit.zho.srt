1
00:00:17,784 --> 00:00:19,219
<c.magenta>大家下午好</c>

2
00:00:19,286 --> 00:00:23,357
<c.magenta>（STOREKIT收条验证</c>

3
00:00:23,423 --> 00:00:26,760
<c.magenta>我是Pete Hare</c>

4
00:00:27,294 --> 00:00:30,364
<c.magenta>你们可能来自于不同的群体</c>

5
00:00:30,430 --> 00:00:34,101
<c.magenta>想要更多地了解</c>

6
00:00:34,168 --> 00:00:35,836
<c.magenta>集成到你的应用之中</c>

7
00:00:35,903 --> 00:00:38,338
<c.magenta>并且安全和可靠地做到这一点</c>

8
00:00:38,605 --> 00:00:41,208
<c.magenta>或许你们想了解订阅</c>

9
00:00:41,275 --> 00:00:44,611
<c.magenta>并且想知道</c>

10
00:00:44,678 --> 00:00:47,347
<c.magenta>跨平台订阅状态维护流程</c>

11
00:00:47,414 --> 00:00:48,348
<c.magenta>诸如此类</c>

12
00:00:48,882 --> 00:00:52,319
<c.magenta>无论你身处哪个群体</c>

13
00:00:52,386 --> 00:00:54,955
<c.magenta>你和用户之间的信任</c>

14
00:00:55,389 --> 00:00:59,359
<c.magenta>当用户花钱购买数字内容或服务时</c>

15
00:00:59,426 --> 00:01:03,931
<c.magenta>他们相信你能够</c>

16
00:00:59,426 --> 00:01:03,931
<c.magenta>他们相信你能够</c>

17
00:01:03,997 --> 00:01:05,632
<c.magenta>安全可靠地交付这些服务和内容</c>

18
00:01:06,533 --> 00:01:09,536
<c.magenta>今天我会讨论这方面的一些技术</c>

19
00:01:09,603 --> 00:01:12,506
<c.magenta>首先 我们会详细讨论收条验证</c>

20
00:01:12,573 --> 00:01:15,242
<c.magenta>今天上午的演讲已经简要讲到这个主题</c>

21
00:01:15,309 --> 00:01:17,911
<c.magenta>我们将会详细介绍</c>

22
00:01:17,978 --> 00:01:19,079
<c.magenta>如何在用户的设备在完成这些工作</c>

23
00:01:19,680 --> 00:01:22,616
<c.magenta>我们还会讨论如何维护订阅状态</c>

24
00:01:22,683 --> 00:01:25,452
<c.magenta>尤其是在服务器上</c>

25
00:01:25,519 --> 00:01:28,422
<c.magenta>更新不同的平台</c>

26
00:01:29,556 --> 00:01:32,359
<c.magenta>最后我们会简单讲述</c>

27
00:01:32,426 --> 00:01:35,028
<c.magenta>在进行开发时</c>

28
00:01:35,095 --> 00:01:37,231
<c.magenta>而不必自己花钱</c>

29
00:01:38,465 --> 00:01:39,466
<c.magenta>让我们来看这张图</c>

30
00:01:39,533 --> 00:01:41,034
<c.magenta>在今天上午的演讲上</c>

31
00:01:41,101 --> 00:01:43,270
<c.magenta>这是程序内购买流程</c>

32
00:01:43,337 --> 00:01:45,038
<c.magenta>你需要在程序中实现这个流程</c>

33
00:01:45,105 --> 00:01:47,875
<c.magenta>以销售程序内购买物品</c>

34
00:01:48,342 --> 00:01:49,343
<c.magenta>在这个演讲中</c>

35
00:01:49,409 --> 00:01:52,012
<c.magenta>我们将重点讨论最后三个环节</c>

36
00:01:52,079 --> 00:01:54,381
<c.magenta>我将它们称为处理交易</c>

37
00:01:54,448 --> 00:01:56,683
<c.magenta>StoreKit发送一个交易给你时</c>

38
00:01:56,750 --> 00:01:59,820
<c.magenta>用户付款之后</c>

39
00:01:59,887 --> 00:02:03,490
<c.magenta>然后交付用户所购买的内容</c>

40
00:01:59,887 --> 00:02:03,490
<c.magenta>然后交付用户所购买的内容</c>

41
00:02:03,657 --> 00:02:05,893
<c.magenta>现在我将扩展这些步骤</c>

42
00:02:05,959 --> 00:02:09,663
<c.magenta>我将引入一个附加层</c>

43
00:02:10,531 --> 00:02:12,866
<c.magenta>本演讲的内容就是这些</c>

44
00:02:12,933 --> 00:02:15,936
<c.magenta>流程是这样的</c>

45
00:02:16,303 --> 00:02:18,705
<c.magenta>这个交易通过StoreKit</c>

46
00:02:19,339 --> 00:02:22,042
<c.magenta>然后你选择是否</c>

47
00:02:22,109 --> 00:02:24,745
<c.magenta>想要在用户的设备或服务器上验证收条</c>

48
00:02:26,713 --> 00:02:30,050
<c.magenta>然后 你检查收条的内容</c>

49
00:02:30,384 --> 00:02:32,619
<c.magenta>解锁内容或者</c>

50
00:02:32,686 --> 00:02:34,588
<c.magenta>更新订阅状态</c>

51
00:02:34,855 --> 00:02:36,290
<c.magenta>此流程的最后一步是</c>

52
00:02:36,356 --> 00:02:39,860
<c.magenta>回到用户的设备上完结交易</c>

53
00:02:40,861 --> 00:02:44,131
<c.magenta>现在你注意到</c>

54
00:02:44,198 --> 00:02:45,933
<c.magenta>在设备级别上完成</c>

55
00:02:45,999 --> 00:02:48,602
<c.magenta>我们不允许交易进入服务器级别</c>

56
00:02:48,669 --> 00:02:49,570
<c.magenta>这一点很重要</c>

57
00:02:49,636 --> 00:02:52,673
<c.magenta>即使你使用服务端流程</c>

58
00:02:52,739 --> 00:02:55,442
<c.magenta>也必须确保</c>

59
00:02:55,509 --> 00:02:56,777
<c.magenta>接收和完结交易</c>

60
00:02:58,745 --> 00:03:00,347
<c.magenta>今天上午</c>

61
00:02:58,745 --> 00:03:00,347
<c.magenta>今天上午</c>

62
00:03:00,414 --> 00:03:02,549
<c.magenta>我们讨论了四种</c>

63
00:03:03,050 --> 00:03:05,919
<c.magenta>如果你处理消费类产品或非消费类产品</c>

64
00:03:05,986 --> 00:03:07,855
<c.magenta>你将需要执行这样的流程</c>

65
00:03:07,921 --> 00:03:09,590
<c.magenta>这是在设备上执行的流程</c>

66
00:03:09,656 --> 00:03:12,326
<c.magenta>你在设备上检查收条和解锁内容</c>

67
00:03:12,392 --> 00:03:15,996
<c.magenta>而不会发送任何内容到服务器</c>

68
00:03:16,563 --> 00:03:17,865
<c.magenta>如果你处理订阅、</c>

69
00:03:17,931 --> 00:03:19,800
<c.magenta>尤其是自动续约订阅</c>

70
00:03:19,867 --> 00:03:22,269
<c.magenta>你将需要</c>

71
00:03:22,336 --> 00:03:24,538
<c.magenta>在服务器上保留状态</c>

72
00:03:24,605 --> 00:03:28,041
<c.magenta>你需要服务器能够更新多台设备</c>

73
00:03:28,575 --> 00:03:31,245
<c.magenta>当然你可以使用这些技术</c>

74
00:03:31,912 --> 00:03:33,981
<c.magenta>但无论哪些方法</c>

75
00:03:34,047 --> 00:03:36,683
<c.magenta>也就是在设备上接收交易</c>

76
00:03:36,750 --> 00:03:40,187
<c.magenta>让我们来看每个步骤</c>

77
00:03:43,123 --> 00:03:45,659
<c.magenta>这是我的应用的生命周期起点</c>

78
00:03:46,159 --> 00:03:48,328
<c.magenta>我们创建应用方法</c>

79
00:03:48,395 --> 00:03:49,830
<c.magenta>此方法含有did finish launching参数</c>

80
00:03:49,897 --> 00:03:51,798
<c.magenta>并且注册一个</c>

81
00:03:51,865 --> 00:03:53,500
<c.magenta>交易观察器</c>

82
00:03:53,567 --> 00:03:56,270
<c.magenta>需要在程序生命周期的早期</c>

83
00:03:56,336 --> 00:03:58,939
<c.magenta>注册这个交易观察器</c>

84
00:03:59,006 --> 00:04:01,642
<c.magenta>接收经过更新的交易</c>

85
00:03:59,006 --> 00:04:01,642
<c.magenta>接收经过更新的交易</c>

86
00:04:01,975 --> 00:04:03,777
<c.magenta>这里我增加AppDelegate</c>

87
00:04:03,844 --> 00:04:05,946
<c.magenta>作为支付观察器</c>

88
00:04:06,013 --> 00:04:08,849
<c.magenta>你也可以添加一个单独的控制器对象</c>

89
00:04:09,116 --> 00:04:10,984
<c.magenta>重要的是</c>

90
00:04:11,051 --> 00:04:12,753
<c.magenta>完成这些工作</c>

91
00:04:12,819 --> 00:04:16,890
<c.magenta>注册之后 就可以</c>

92
00:04:16,957 --> 00:04:18,992
<c.magenta>开始通过更新交易回调</c>

93
00:04:19,526 --> 00:04:23,197
<c.magenta>就是交易观察器中的</c>

94
00:04:23,897 --> 00:04:26,800
<c.magenta>你收到一个交易数组</c>

95
00:04:26,900 --> 00:04:29,336
<c.magenta>可以检查每个交易的</c>

96
00:04:29,403 --> 00:04:31,538
<c.magenta>你需要查看处于购买状态的交易</c>

97
00:04:31,605 --> 00:04:34,675
<c.magenta>StoreKit认为</c>

98
00:04:34,741 --> 00:04:37,811
<c.magenta>你可以验证交易</c>

99
00:04:37,878 --> 00:04:40,814
<c.magenta>它告诉用户已经付款</c>

100
00:04:42,749 --> 00:04:44,818
<c.magenta>获得处于购买状态的交易之后</c>

101
00:04:44,885 --> 00:04:47,654
<c.magenta>你准备进行这个图表中的下一步处理</c>

102
00:04:47,855 --> 00:04:51,358
<c.magenta>让我们首先来看</c>

103
00:04:51,425 --> 00:04:52,893
<c.magenta>进行收条验证</c>

104
00:04:53,260 --> 00:04:54,828
<c.magenta>那么收条是什么？</c>

105
00:04:54,895 --> 00:04:56,196
<c.magenta>今天上午我们已经讲过</c>

106
00:04:56,263 --> 00:04:57,698
<c.magenta>但你们一些人可能没参加那个演讲</c>

107
00:04:57,764 --> 00:04:59,433
<c.magenta>收条就像是文件</c>

108
00:04:59,499 --> 00:05:01,468
<c.magenta>就像百货商店开出的收据一样</c>

109
00:04:59,499 --> 00:05:01,468
<c.magenta>就像百货商店开出的收据一样</c>

110
00:05:01,535 --> 00:05:04,571
<c.magenta>它是购买凭据</c>

111
00:05:04,638 --> 00:05:07,107
<c.magenta>表明用户确实已经购买</c>

112
00:05:07,174 --> 00:05:10,577
<c.magenta>这是一个程序收条</c>

113
00:05:10,644 --> 00:05:14,248
<c.magenta>程序内购买凭证</c>

114
00:05:14,915 --> 00:05:17,251
<c.magenta>这个收条存储在设备上</c>

115
00:05:17,551 --> 00:05:20,254
<c.magenta>由App Store签发</c>

116
00:05:21,021 --> 00:05:24,858
<c.magenta>它相当于一个可检验的文件</c>

117
00:05:24,925 --> 00:05:27,861
<c.magenta>检查此文件是否确实由Apple签发</c>

118
00:05:27,928 --> 00:05:30,764
<c.magenta>并且放在用户设备上</c>

119
00:05:32,065 --> 00:05:34,434
<c.magenta>最后 它只能在设备上</c>

120
00:05:34,902 --> 00:05:36,370
<c.magenta>这意味着不能</c>

121
00:05:36,436 --> 00:05:38,472
<c.magenta>或者与其它程序共享</c>

122
00:05:39,640 --> 00:05:42,910
<c.magenta>在收条验证方面</c>

123
00:05:42,976 --> 00:05:44,678
<c.magenta>确保此文件是可信文件</c>

124
00:05:44,745 --> 00:05:47,080
<c.magenta>而不是某个人的假文件</c>

125
00:05:47,147 --> 00:05:48,081
<c.magenta>这有两种方法</c>

126
00:05:48,148 --> 00:05:50,851
<c.magenta>可以在设备上验证</c>

127
00:05:51,351 --> 00:05:53,954
<c.magenta>也可以发送到服务器</c>

128
00:05:54,021 --> 00:05:55,889
<c.magenta>使用服务器对服务器验证方法</c>

129
00:05:56,690 --> 00:05:58,992
<c.magenta>需要指出的是</c>

130
00:05:59,059 --> 00:06:01,128
<c.magenta>一定不能直接在用户设备上</c>

131
00:05:59,059 --> 00:06:01,128
<c.magenta>一定不能直接在用户设备上</c>

132
00:06:01,195 --> 00:06:02,930
<c.magenta>使用在线验证</c>

133
00:06:02,996 --> 00:06:05,399
<c.magenta>因为这不是安全的验证方法</c>

134
00:06:05,465 --> 00:06:07,134
<c.magenta>如果在设备上验证</c>

135
00:06:07,201 --> 00:06:09,803
<c.magenta>你需要使用</c>

136
00:06:10,871 --> 00:06:14,374
<c.magenta>收条看上去是什么样的？</c>

137
00:06:15,776 --> 00:06:16,910
<c.magenta>收条文件</c>

138
00:06:17,277 --> 00:06:19,580
<c.magenta>我们获得程序的所有购买信息</c>

139
00:06:19,646 --> 00:06:20,781
<c.magenta>包括所有程序内购买</c>

140
00:06:20,848 --> 00:06:24,017
<c.magenta>另外还有证书和签名</c>

141
00:06:24,084 --> 00:06:27,187
<c.magenta>用于创建文件</c>

142
00:06:27,254 --> 00:06:29,957
<c.magenta>此文件存储在程序捆绑包内</c>

143
00:06:30,023 --> 00:06:33,660
<c.magenta>我们提供一个API</c>

144
00:06:34,328 --> 00:06:35,596
<c.magenta>它是一个单文件</c>

145
00:06:35,829 --> 00:06:38,465
<c.magenta>含有程序的所有购买数据</c>

146
00:06:38,532 --> 00:06:40,801
<c.magenta>和已经发生的程序内购买</c>

147
00:06:40,868 --> 00:06:44,805
<c.magenta>包括一个签名</c>

148
00:06:44,872 --> 00:06:46,607
<c.magenta>确保它是Apple签发的</c>

149
00:06:47,808 --> 00:06:50,310
<c.magenta>此文件基于一系列的工业标准</c>

150
00:06:50,377 --> 00:06:51,612
<c.magenta>它使用公钥加密标准</c>

151
00:06:51,678 --> 00:06:55,249
<c.magenta>进行签名</c>

152
00:06:56,116 --> 00:06:58,552
<c.magenta>使用ASN.1数据编码方法进行编码</c>

153
00:06:58,619 --> 00:07:01,321
<c.magenta>不要对这些缩写术语感到困惑</c>

154
00:06:58,619 --> 00:07:01,321
<c.magenta>不要对这些缩写术语感到困惑</c>

155
00:07:01,388 --> 00:07:03,590
<c.magenta>它们都是公开标准</c>

156
00:07:03,657 --> 00:07:05,626
<c.magenta>可以在网上</c>

157
00:07:05,692 --> 00:07:07,828
<c.magenta>找到许多的相关信息</c>

158
00:07:08,195 --> 00:07:11,665
<c.magenta>你可能熟悉的一种加密技术</c>

159
00:07:11,732 --> 00:07:12,966
<c.magenta>OpenSSL是一个框架</c>

160
00:07:13,033 --> 00:07:16,803
<c.magenta>不仅提供安全网页传输隧道功能</c>

161
00:07:16,870 --> 00:07:18,305
<c.magenta>且能从ASN.1数据负载中</c>

162
00:07:18,372 --> 00:07:21,375
<c.magenta>读取数据编码</c>

163
00:07:21,441 --> 00:07:24,711
<c.magenta>并且在这样的密文容器上检查签名</c>

164
00:07:25,546 --> 00:07:28,081
<c.magenta>当然 你可以使用</c>

165
00:07:28,148 --> 00:07:31,552
<c.magenta>也可以直接读取特定的数据</c>

166
00:07:31,618 --> 00:07:34,454
<c.magenta>你和你的公司应该</c>

167
00:07:34,521 --> 00:07:38,559
<c.magenta>你可以看到 在安全方面</c>

168
00:07:38,625 --> 00:07:41,061
<c.magenta>并不是二项选择</c>

169
00:07:41,128 --> 00:07:42,429
<c.magenta>安全是一种程度</c>

170
00:07:42,496 --> 00:07:45,465
<c.magenta>你必须自己决定</c>

171
00:07:45,532 --> 00:07:47,734
<c.magenta>来验证这些购买</c>

172
00:07:48,936 --> 00:07:52,239
<c.magenta>无论哪种方法 首先都需要</c>

173
00:07:52,306 --> 00:07:54,541
<c.magenta>你可以使用前面提到的API</c>

174
00:07:54,608 --> 00:07:58,478
<c.magenta>即Bundle.AppStoreReceiptURL API</c>

175
00:07:59,112 --> 00:08:02,816
<c.magenta>它提供一个URL</c>

176
00:07:59,112 --> 00:08:02,816
<c.magenta>它提供一个URL</c>

177
00:08:02,883 --> 00:08:06,220
<c.magenta>你可以读取收条对象的加密二进制数据</c>

178
00:08:06,286 --> 00:08:10,958
<c.magenta>加密二进制数据现已读取到内存之中</c>

179
00:08:13,527 --> 00:08:15,596
<c.magenta>一点提示</c>

180
00:08:15,662 --> 00:08:17,064
<c.magenta>在本演讲中</c>

181
00:08:17,130 --> 00:08:18,866
<c.magenta>不会介绍OpenSSL使用流程</c>

182
00:08:19,566 --> 00:08:21,702
<c.magenta>但你们该知道</c>

183
00:08:22,169 --> 00:08:24,872
<c.magenta>你必须自己创建并且加入到你的程序</c>

184
00:08:25,205 --> 00:08:28,308
<c.magenta>你应该将它作为程序的静态库</c>

185
00:08:28,375 --> 00:08:30,511
<c.magenta>而不是动态库</c>

186
00:08:30,844 --> 00:08:33,246
<c.magenta>如果使用动态库</c>

187
00:08:33,313 --> 00:08:37,484
<c.magenta>很容易被其它人调换为伪造的动态库</c>

188
00:08:37,551 --> 00:08:40,386
<c.magenta>而影响程序二进制代码中的</c>

189
00:08:40,453 --> 00:08:43,423
<c.magenta>静态库意味着</c>

190
00:08:43,490 --> 00:08:45,325
<c.magenta>二进制数据封装在你的程序之内</c>

191
00:08:45,392 --> 00:08:48,228
<c.magenta>其他人难以撰改</c>

192
00:08:49,463 --> 00:08:51,064
<c.magenta>在证书检查方面</c>

193
00:08:51,131 --> 00:08:52,699
<c.magenta>你可以从Apple网站</c>

194
00:08:52,766 --> 00:08:55,369
<c.magenta>这是官方证书</c>

195
00:08:55,435 --> 00:08:57,504
<c.magenta>可以使得这个证书执行检查</c>

196
00:08:57,571 --> 00:09:01,508
<c.magenta>使用OpenSSL查看</c>

197
00:08:57,571 --> 00:09:01,508
<c.magenta>使用OpenSSL查看</c>

198
00:09:01,775 --> 00:09:04,845
<c.magenta>如果绑定到程序中</c>

199
00:09:04,912 --> 00:09:07,014
<c.magenta>应该注意</c>

200
00:09:07,080 --> 00:09:09,983
<c.magenta>加入到捆绑程序中的</c>

201
00:09:10,984 --> 00:09:12,753
<c.magenta>这方面网上有很多的文档</c>

202
00:09:12,819 --> 00:09:14,888
<c.magenta>事实上 几年前我们有一个演讲</c>

203
00:09:14,955 --> 00:09:18,058
<c.magenta>实时演示如何使用OpenSSL</c>

204
00:09:18,125 --> 00:09:19,660
<c.magenta>并进行验证</c>

205
00:09:19,726 --> 00:09:21,461
<c.magenta>这个过程比较简单</c>

206
00:09:21,528 --> 00:09:24,064
<c.magenta>希望你们观看以前的</c>

207
00:09:24,131 --> 00:09:26,400
<c.magenta>收条验证演讲视频</c>

208
00:09:28,035 --> 00:09:30,537
<c.magenta>在现成解决方案方面</c>

209
00:09:30,604 --> 00:09:34,074
<c.magenta>尝试过集成程序内购买</c>

210
00:09:34,141 --> 00:09:37,811
<c.magenta>以找到一个现成的解决方案</c>

211
00:09:38,612 --> 00:09:41,114
<c.magenta>请记住 当你下载现成解决方案时</c>

212
00:09:41,181 --> 00:09:42,783
<c.magenta>虽然获得便利 但也会有所让步</c>

213
00:09:43,851 --> 00:09:47,387
<c.magenta>重复使用这样的代码</c>

214
00:09:47,454 --> 00:09:51,658
<c.magenta>对于StoreKit等</c>

215
00:09:52,092 --> 00:09:54,061
<c.magenta>你能想象全国的珠宝商</c>

216
00:09:54,127 --> 00:09:55,996
<c.magenta>都使用同一把钥匙打开其保险箱吗？</c>

217
00:09:56,063 --> 00:09:59,032
<c.magenta>只要这把锁有一个缺陷被发现</c>

218
00:09:59,099 --> 00:10:00,667
<c.magenta>全国的珠宝商的</c>

219
00:09:59,099 --> 00:10:00,667
<c.magenta>全国的珠宝商的</c>

220
00:10:00,734 --> 00:10:03,971
<c.magenta>财产安全都会受到威胁</c>

221
00:10:04,705 --> 00:10:06,306
<c.magenta>对你们来说</c>

222
00:10:06,373 --> 00:10:07,841
<c.magenta>应该知道这样做的风险</c>

223
00:10:07,908 --> 00:10:11,778
<c.magenta>请记住 当你们使用StoreKit</c>

224
00:10:11,845 --> 00:10:12,813
<c.magenta>这关系到你的收入流</c>

225
00:10:12,880 --> 00:10:15,816
<c.magenta>开发现成解决方案的人</c>

226
00:10:15,883 --> 00:10:18,986
<c.magenta>并不像你自己一样</c>

227
00:10:22,656 --> 00:10:25,259
<c.magenta>当你验证实际证书</c>

228
00:10:25,325 --> 00:10:28,161
<c.magenta>以签名收条时</c>

229
00:10:28,529 --> 00:10:31,298
<c.magenta>你不必实际检查</c>

230
00:10:31,365 --> 00:10:32,966
<c.magenta>证书的有效日期</c>

231
00:10:34,535 --> 00:10:35,369
<c.magenta>我的意思是</c>

232
00:10:35,435 --> 00:10:38,372
<c.magenta>如果收条是特定时间加密的</c>

233
00:10:38,438 --> 00:10:39,506
<c.magenta>比如说两年前</c>

234
00:10:39,573 --> 00:10:42,643
<c.magenta>然后有人使用当时有效的证书</c>

235
00:10:42,709 --> 00:10:45,078
<c.magenta>那么证书应该在稍后不久过期</c>

236
00:10:45,145 --> 00:10:47,414
<c.magenta>证书已经过期</c>

237
00:10:47,481 --> 00:10:50,217
<c.magenta>并不会使收条失效</c>

238
00:10:50,284 --> 00:10:51,351
<c.magenta>在这里 重要的一点</c>

239
00:10:51,418 --> 00:10:54,054
<c.magenta>并不是证书是否仍然有效</c>

240
00:10:54,121 --> 00:10:56,023
<c.magenta>真正重要的是</c>

241
00:10:56,089 --> 00:10:57,791
<c.magenta>在生成收条时 证书是否有效</c>

242
00:10:57,858 --> 00:11:01,361
<c.magenta>应该将证书日期与</c>

243
00:10:57,858 --> 00:11:01,361
<c.magenta>应该将证书日期与</c>

244
00:11:01,428 --> 00:11:03,063
<c.magenta>收条内的购买日期比较</c>

245
00:11:03,130 --> 00:11:05,199
<c.magenta>确保在签名之时证书是有效的</c>

246
00:11:07,134 --> 00:11:09,136
<c.magenta>让我们来看收条的实际内容</c>

247
00:11:09,203 --> 00:11:11,705
<c.magenta>这是ASN.1编码内容</c>

248
00:11:12,072 --> 00:11:14,341
<c.magenta>它是一系列的类型和值</c>

249
00:11:14,608 --> 00:11:15,442
<c.magenta>很像词典</c>

250
00:11:15,509 --> 00:11:18,545
<c.magenta>可以把它视为词典</c>

251
00:11:18,745 --> 00:11:20,647
<c.magenta>可以读取</c>

252
00:11:20,714 --> 00:11:22,049
<c.magenta>这些不同类型的值</c>

253
00:11:22,583 --> 00:11:25,419
<c.magenta>现在你已经检查</c>

254
00:11:25,485 --> 00:11:27,454
<c.magenta>使用正确的Apple证书进行签名</c>

255
00:11:27,988 --> 00:11:31,658
<c.magenta>你需要确定进行签名的程序</c>

256
00:11:31,725 --> 00:11:33,994
<c.magenta>就是用户运行的程序</c>

257
00:11:34,962 --> 00:11:37,130
<c.magenta>为了确定此收条用于此程序</c>

258
00:11:37,197 --> 00:11:38,932
<c.magenta>可以使用两种类型的属性</c>

259
00:11:38,999 --> 00:11:40,200
<c.magenta>即类型2和3</c>

260
00:11:40,267 --> 00:11:43,070
<c.magenta>它们含有此收条的适用程序的</c>

261
00:11:43,136 --> 00:11:45,739
<c.magenta>和捆绑包版本</c>

262
00:11:46,640 --> 00:11:49,710
<c.magenta>你需要将这两个特定属性</c>

263
00:11:49,776 --> 00:11:52,179
<c.magenta>与程序内的硬编码值进行比较</c>

264
00:11:52,479 --> 00:11:54,047
<c.magenta>重要的一点是</c>

265
00:11:54,114 --> 00:11:56,016
<c.magenta>原因前面我们已经讲过</c>

266
00:11:56,850 --> 00:11:59,753
<c.magenta>这是一个info.plist文件</c>

267
00:11:59,820 --> 00:12:02,589
<c.magenta>替换这个plist文件</c>

268
00:11:59,820 --> 00:12:02,589
<c.magenta>替换这个plist文件</c>

269
00:12:02,656 --> 00:12:06,760
<c.magenta>相比之下 替换内容</c>

270
00:12:07,828 --> 00:12:10,030
<c.magenta>将这两个类型</c>

271
00:12:10,097 --> 00:12:11,231
<c.magenta>如果它们匹配 则一切正常</c>

272
00:12:11,298 --> 00:12:14,301
<c.magenta>现在你已经确认程序是正确的</c>

273
00:12:14,902 --> 00:12:17,070
<c.magenta>接下来的步骤是</c>

274
00:12:17,137 --> 00:12:19,072
<c.magenta>是否与文件匹配</c>

275
00:12:19,373 --> 00:12:23,143
<c.magenta>我们使用类型4和5</c>

276
00:12:23,210 --> 00:12:25,379
<c.magenta>需要检查是的第5个属性</c>

277
00:12:26,046 --> 00:12:29,583
<c.magenta>第5个属性实际上</c>

278
00:12:29,650 --> 00:12:31,752
<c.magenta>这是捆绑包ID和</c>

279
00:12:31,818 --> 00:12:35,255
<c.magenta>我们提供API读取设备ID</c>

280
00:12:35,889 --> 00:12:37,257
<c.magenta>第三个是非透明值</c>

281
00:12:37,324 --> 00:12:40,194
<c.magenta>它实际上是类型4中的属性</c>

282
00:12:40,260 --> 00:12:41,762
<c.magenta>我们这样做的原因是</c>

283
00:12:41,828 --> 00:12:43,330
<c.magenta>它使用加密技术</c>

284
00:12:43,397 --> 00:12:46,800
<c.magenta>允许SHA-1哈希值随时间变化</c>

285
00:12:46,867 --> 00:12:49,436
<c.magenta>即使捆绑包ID</c>

286
00:12:49,570 --> 00:12:51,939
<c.magenta>从而增加过程安全性</c>

287
00:12:52,739 --> 00:12:56,577
<c.magenta>因此 这个SHA-1值</c>

288
00:12:57,277 --> 00:12:59,880
<c.magenta>你要做的是</c>

289
00:12:59,947 --> 00:13:02,516
<c.magenta>创建这个SHA-1值</c>

290
00:12:59,947 --> 00:13:02,516
<c.magenta>创建这个SHA-1值</c>

291
00:13:02,583 --> 00:13:04,751
<c.magenta>然后将它与类型5的值进行比较</c>

292
00:13:04,818 --> 00:13:06,887
<c.magenta>如果匹配 则一切正常</c>

293
00:13:06,954 --> 00:13:09,156
<c.magenta>这样你就确定</c>

294
00:13:09,223 --> 00:13:10,991
<c.magenta>就是收条的目标设备</c>

295
00:13:12,759 --> 00:13:14,661
<c.magenta>现在你已经完成这三项检查</c>

296
00:13:15,662 --> 00:13:17,898
<c.magenta>这个过程就是</c>

297
00:13:17,965 --> 00:13:19,933
<c.magenta>现在你知道这是一个可信文件</c>

298
00:13:20,000 --> 00:13:22,202
<c.magenta>可以从它读取更多信息</c>

299
00:13:22,269 --> 00:13:23,971
<c.magenta>让我们来看下面的步骤</c>

300
00:13:24,371 --> 00:13:27,207
<c.magenta>即更新和检查</c>

301
00:13:27,274 --> 00:13:29,676
<c.magenta>的状态和内容</c>

302
00:13:31,044 --> 00:13:34,248
<c.magenta>让我们回过来看</c>

303
00:13:34,982 --> 00:13:38,051
<c.magenta>收条含有一个特定的类型</c>

304
00:13:38,118 --> 00:13:42,623
<c.magenta>用户在设备上</c>

305
00:13:43,123 --> 00:13:48,929
<c.magenta>在每个类型17中 实际数据是</c>

306
00:13:50,030 --> 00:13:53,100
<c.magenta>在这个容器内</c>

307
00:13:53,166 --> 00:13:56,069
<c.magenta>与特定的交易相关联</c>

308
00:13:56,136 --> 00:13:59,940
<c.magenta>这样我们获得数量、</c>

309
00:14:00,007 --> 00:14:01,642
<c.magenta>你可以使用这些值</c>

310
00:14:01,708 --> 00:14:05,179
<c.magenta>来检查是否确实存在这样的交易</c>

311
00:14:05,812 --> 00:14:08,148
<c.magenta>我特别要指出的是类型1708</c>

312
00:14:08,215 --> 00:14:11,618
<c.magenta>如果你处理自动续约订阅</c>

313
00:14:11,818 --> 00:14:14,788
<c.magenta>它含有特定交易的</c>

314
00:14:14,855 --> 00:14:16,190
<c.magenta>结算截止日期</c>

315
00:14:16,490 --> 00:14:18,759
<c.magenta>稍后我们将会讨论订阅</c>

316
00:14:19,560 --> 00:14:22,596
<c.magenta>如果想要了解</c>

317
00:14:22,663 --> 00:14:26,333
<c.magenta>建议你们观看</c>

318
00:14:26,400 --> 00:14:30,504
<c.magenta>我们介绍了收条中</c>

319
00:14:32,039 --> 00:14:34,208
<c.magenta>现在你可以读出这些交易信息</c>

320
00:14:34,908 --> 00:14:37,177
<c.magenta>你可以使用这些信息</c>

321
00:14:37,544 --> 00:14:39,646
<c.magenta>StoreKit告诉你的</c>

322
00:14:39,780 --> 00:14:41,715
<c.magenta>你要做的是通过这个</c>

323
00:14:41,782 --> 00:14:45,018
<c.magenta>获取交易信息值</c>

324
00:14:45,085 --> 00:14:48,422
<c.magenta>将这些值与收条内的值进行比较</c>

325
00:14:48,488 --> 00:14:50,224
<c.magenta>你可以使用交易ID、</c>

326
00:14:50,290 --> 00:14:53,994
<c.magenta>购买日期 用户所购买产品</c>

327
00:14:54,061 --> 00:14:56,830
<c.magenta>如果你确认交易匹配</c>

328
00:14:56,897 --> 00:14:59,900
<c.magenta>将会获得一个文件</c>

329
00:14:59,967 --> 00:15:01,468
<c.magenta>而且已经进行支付</c>

330
00:14:59,967 --> 00:15:01,468
<c.magenta>而且已经进行支付</c>

331
00:15:01,535 --> 00:15:04,505
<c.magenta>你可以信任StoreKit</c>

332
00:15:06,039 --> 00:15:08,909
<c.magenta>当你处理订阅时</c>

333
00:15:08,976 --> 00:15:11,011
<c.magenta>“我的用户是否具有有效的订阅？”</c>

334
00:15:12,312 --> 00:15:15,115
<c.magenta>这里需要注意的是</c>

335
00:15:15,182 --> 00:15:17,518
<c.magenta>获得订阅用户</c>

336
00:15:17,651 --> 00:15:19,353
<c.magenta>有时候这会让人感到困惑</c>

337
00:15:19,419 --> 00:15:20,487
<c.magenta>如果你可以验证收条</c>

338
00:15:20,554 --> 00:15:22,789
<c.magenta>这并不意味着用户已经进行支付</c>

339
00:15:22,890 --> 00:15:24,291
<c.magenta>每个应用都有收条</c>

340
00:15:24,358 --> 00:15:27,427
<c.magenta>它含有任何原始应用购买相关信息</c>

341
00:15:27,494 --> 00:15:28,662
<c.magenta>甚至免费应用也是如此</c>

342
00:15:29,029 --> 00:15:31,098
<c.magenta>收条内的数据</c>

343
00:15:31,164 --> 00:15:33,634
<c.magenta>向你告诉用户的订阅状态</c>

344
00:15:34,935 --> 00:15:36,904
<c.magenta>我们如何找出订阅状态呢？</c>

345
00:15:37,437 --> 00:15:39,139
<c.magenta>你可以获取这些交易信息</c>

346
00:15:39,206 --> 00:15:42,843
<c.magenta>按照原始交易ID字段对它们分组</c>

347
00:15:43,310 --> 00:15:45,879
<c.magenta>交易ID字段含有</c>

348
00:15:45,946 --> 00:15:48,615
<c.magenta>用户的特定自动续约订阅的</c>

349
00:15:48,682 --> 00:15:51,685
<c.magenta>可以将它视为订阅ID</c>

350
00:15:51,752 --> 00:15:54,855
<c.magenta>用于引用和分组这些交易</c>

351
00:15:55,622 --> 00:15:57,391
<c.magenta>你可以抓取这些交易信息</c>

352
00:15:57,457 --> 00:16:00,360
<c.magenta>并可以查看即将过期的交易</c>

353
00:15:57,457 --> 00:16:00,360
<c.magenta>并可以查看即将过期的交易</c>

354
00:16:00,460 --> 00:16:03,830
<c.magenta>这表示已经发生的最新交易</c>

355
00:16:03,897 --> 00:16:05,933
<c.magenta>如果找到截止日期</c>

356
00:16:05,999 --> 00:16:08,435
<c.magenta>表示用户的计费期还没有结束</c>

357
00:16:08,502 --> 00:16:09,837
<c.magenta>而且他们具有有效的订阅</c>

358
00:16:10,137 --> 00:16:12,973
<c.magenta>如果你找到过去的截止日期</c>

359
00:16:13,040 --> 00:16:15,342
<c.magenta>则表示从那时起没有发生任何交易</c>

360
00:16:15,409 --> 00:16:17,644
<c.magenta>用户的订阅已经过期</c>

361
00:16:18,212 --> 00:16:21,114
<c.magenta>如果你找到截止日期数据</c>

362
00:16:21,181 --> 00:16:23,150
<c.magenta>你可以发送接收刷新属性</c>

363
00:16:24,084 --> 00:16:27,321
<c.magenta>获取最新的收条副本</c>

364
00:16:27,387 --> 00:16:29,890
<c.magenta>然后你可以</c>

365
00:16:29,957 --> 00:16:32,926
<c.magenta>重复收条验证步骤</c>

366
00:16:32,993 --> 00:16:35,229
<c.magenta>了解是否发生过任何新交易</c>

367
00:16:36,330 --> 00:16:38,498
<c.magenta>在设备上维护</c>

368
00:16:38,565 --> 00:16:40,334
<c.magenta>需要注意一点</c>

369
00:16:40,400 --> 00:16:44,071
<c.magenta>前面我们讲过截止日期</c>

370
00:16:44,137 --> 00:16:46,473
<c.magenta>如果你在设备进行这些操作</c>

371
00:16:46,540 --> 00:16:49,910
<c.magenta>你仅需要将这些日期</c>

372
00:16:49,977 --> 00:16:52,546
<c.magenta>用户可能会回调系统时间</c>

373
00:16:52,613 --> 00:16:55,315
<c.magenta>让他们仍然处于有效订阅期</c>

374
00:16:56,750 --> 00:16:58,151
<c.magenta>并没有办法防止他们这样做</c>

375
00:16:58,218 --> 00:17:00,921
<c.magenta>如果你遇到这样的问题</c>

376
00:16:58,218 --> 00:17:00,921
<c.magenta>如果你遇到这样的问题</c>

377
00:17:00,988 --> 00:17:03,090
<c.magenta>可能需要使用服务端解决方案</c>

378
00:17:03,156 --> 00:17:05,925
<c.magenta>可能需要在服务器上验证收条</c>

379
00:17:05,992 --> 00:17:09,396
<c.magenta>或者至少从服务器</c>

380
00:17:11,265 --> 00:17:12,833
<c.magenta>如我前面所述</c>

381
00:17:12,900 --> 00:17:14,001
<c.magenta>当收条不存在或无效时</c>

382
00:17:14,067 --> 00:17:16,435
<c.magenta>或者你要搜索额外的交易</c>

383
00:17:16,502 --> 00:17:18,839
<c.magenta>可以发送刷新请求</c>

384
00:17:19,039 --> 00:17:21,974
<c.magenta>这需要发送网络请求</c>

385
00:17:22,041 --> 00:17:26,146
<c.magenta>取回新收条</c>

386
00:17:26,213 --> 00:17:27,347
<c.magenta>因此你应该十分注意</c>

387
00:17:27,414 --> 00:17:28,749
<c.magenta>避免频繁地这样做</c>

388
00:17:28,815 --> 00:17:31,552
<c.magenta>应该避免持续性的验证和刷新</c>

389
00:17:31,618 --> 00:17:33,554
<c.magenta>如果你进行前面所述的操作</c>

390
00:17:33,620 --> 00:17:36,690
<c.magenta>即查找截止日期</c>

391
00:17:36,757 --> 00:17:39,860
<c.magenta>不会持续地提交收条刷新请求</c>

392
00:17:39,927 --> 00:17:42,462
<c.magenta>因为这会反复提示用户登录</c>

393
00:17:42,529 --> 00:17:45,699
<c.magenta>只应该发送一次请求</c>

394
00:17:45,766 --> 00:17:47,501
<c.magenta>代码看起来是这样的</c>

395
00:17:47,801 --> 00:17:50,504
<c.magenta>你创建一个</c>

396
00:17:50,571 --> 00:17:52,339
<c.magenta>为它设置委托</c>

397
00:17:52,406 --> 00:17:53,707
<c.magenta>然后使用start方法启动</c>

398
00:17:55,442 --> 00:17:57,578
<c.magenta>在mac iOS上</c>

399
00:17:57,811 --> 00:18:00,781
<c.magenta>应该遵循同样的原则</c>

400
00:17:57,811 --> 00:18:00,781
<c.magenta>应该遵循同样的原则</c>

401
00:18:01,315 --> 00:18:03,750
<c.magenta>这会发送网格请求</c>

402
00:18:03,817 --> 00:18:05,786
<c.magenta>并且要求用户登录</c>

403
00:18:05,853 --> 00:18:07,487
<c.magenta>但是在本例中</c>

404
00:18:07,554 --> 00:18:11,458
<c.magenta>你要做的是</c>

405
00:18:12,092 --> 00:18:14,661
<c.magenta>看起来是这样的</c>

406
00:18:14,728 --> 00:18:16,129
<c.magenta>在后台触发StoreKit</c>

407
00:18:16,196 --> 00:18:17,931
<c.magenta>并且下载新收条</c>

408
00:18:17,998 --> 00:18:22,069
<c.magenta>到Mac计算机上</c>

409
00:18:23,670 --> 00:18:26,039
<c.magenta>现在我们来看</c>

410
00:18:26,106 --> 00:18:29,009
<c.magenta>恢复交易与刷新收条的不同之处</c>

411
00:18:29,076 --> 00:18:32,479
<c.magenta>有时候这会让人感到困惑</c>

412
00:18:33,046 --> 00:18:36,250
<c.magenta>关于恢复完整交易的API</c>

413
00:18:36,316 --> 00:18:38,485
<c.magenta>我们已在今天上午</c>

414
00:18:38,552 --> 00:18:41,221
<c.magenta>这一个SK支付队列API</c>

415
00:18:41,889 --> 00:18:45,192
<c.magenta>收条刷新请求是你创建的一个实例</c>

416
00:18:45,259 --> 00:18:46,960
<c.magenta>你使用start方法启动它</c>

417
00:18:47,060 --> 00:18:48,829
<c.magenta>它们的功能略有不同</c>

418
00:18:48,896 --> 00:18:53,233
<c.magenta>恢复完整交易</c>

419
00:18:53,300 --> 00:18:55,169
<c.magenta>取回用户的所有已完成交易</c>

420
00:18:55,235 --> 00:18:59,239
<c.magenta>让你能够进行处理</c>

421
00:18:59,840 --> 00:19:01,708
<c.magenta>收条更新请求</c>

422
00:18:59,840 --> 00:19:01,708
<c.magenta>收条更新请求</c>

423
00:19:01,775 --> 00:19:04,278
<c.magenta>实际上是取回新收条文件</c>

424
00:19:04,344 --> 00:19:08,515
<c.magenta>此文件是加密二进制代码</c>

425
00:19:09,483 --> 00:19:11,952
<c.magenta>这两个操作返回的结果</c>

426
00:19:12,019 --> 00:19:14,655
<c.magenta>当你恢复完整交易时</c>

427
00:19:14,721 --> 00:19:16,623
<c.magenta>仅恢复非消费性产品</c>

428
00:19:16,690 --> 00:19:18,659
<c.magenta>和自动续约订阅产品</c>

429
00:19:19,760 --> 00:19:23,230
<c.magenta>收条刷新请求</c>

430
00:19:23,297 --> 00:19:26,900
<c.magenta>而且包含收条中的</c>

431
00:19:27,267 --> 00:19:29,002
<c.magenta>你会注意到</c>

432
00:19:29,069 --> 00:19:31,371
<c.magenta>这两种类型的请求</c>

433
00:19:31,438 --> 00:19:34,174
<c.magenta>如果你处理消费性产品购买</c>

434
00:19:34,241 --> 00:19:36,910
<c.magenta>它们只会出现</c>

435
00:19:36,977 --> 00:19:39,246
<c.magenta>和购买时的收条之中</c>

436
00:19:39,313 --> 00:19:42,783
<c.magenta>因此 你可以检查消费性产品</c>

437
00:19:42,850 --> 00:19:45,319
<c.magenta>但是这两种调用不会取回它</c>

438
00:19:46,153 --> 00:19:48,422
<c.magenta>关于收条处理的另一个技巧是</c>

439
00:19:48,488 --> 00:19:49,957
<c.magenta>如果你想要切换到订阅产品</c>

440
00:19:50,023 --> 00:19:51,225
<c.magenta>你可能有一个付费应用</c>

441
00:19:51,291 --> 00:19:53,760
<c.magenta>想要把它切换到订阅模式</c>

442
00:19:53,827 --> 00:19:57,865
<c.magenta>可以在程序收条中</c>

443
00:19:58,599 --> 00:20:00,534
<c.magenta>它包含原始程序版本</c>

444
00:19:58,599 --> 00:20:00,534
<c.magenta>它包含原始程序版本</c>

445
00:20:00,601 --> 00:20:04,171
<c.magenta>可以使用</c>

446
00:20:04,238 --> 00:20:06,773
<c.magenta>以了解你是否应该需要</c>

447
00:20:06,840 --> 00:20:09,877
<c.magenta>在付费程序或订阅模式</c>

448
00:20:09,943 --> 00:20:12,279
<c.magenta>我们知道</c>

449
00:20:12,346 --> 00:20:15,115
<c.magenta>如果突然终止付费使用的功能</c>

450
00:20:15,182 --> 00:20:16,216
<c.magenta>对于订阅模式</c>

451
00:20:16,283 --> 00:20:20,521
<c.magenta>可以使用类型19</c>

452
00:20:21,555 --> 00:20:23,891
<c.magenta>这个步骤是在设备上检查交易</c>

453
00:20:23,957 --> 00:20:26,827
<c.magenta>和确认订阅状态</c>

454
00:20:27,094 --> 00:20:28,996
<c.magenta>在这个步骤之后</c>

455
00:20:29,062 --> 00:20:31,431
<c.magenta>你向用户提供内容</c>

456
00:20:31,498 --> 00:20:33,433
<c.magenta>更新订阅</c>

457
00:20:33,500 --> 00:20:35,569
<c.magenta>当完结交易时</c>

458
00:20:36,537 --> 00:20:38,338
<c.magenta>你应该记住</c>

459
00:20:38,405 --> 00:20:39,706
<c.magenta>所有交易</c>

460
00:20:39,773 --> 00:20:42,576
<c.magenta>但是仅应该</c>

461
00:20:43,544 --> 00:20:46,380
<c.magenta>也许你正在下载</c>

462
00:20:46,446 --> 00:20:48,515
<c.magenta>应该确保下载完成之后</c>

463
00:20:48,582 --> 00:20:50,751
<c.magenta>再完结交易</c>

464
00:20:51,485 --> 00:20:54,555
<c.magenta>对于所有自动续约订阅交易来说</c>

465
00:20:54,621 --> 00:20:55,889
<c.magenta>对于在每个结算周期结束时</c>

466
00:20:55,956 --> 00:20:57,658
<c.magenta>发生的可续约交易</c>

467
00:20:57,724 --> 00:21:00,727
<c.magenta>你仍然需要完结所有这些交易</c>

468
00:20:57,724 --> 00:21:00,727
<c.magenta>你仍然需要完结所有这些交易</c>

469
00:21:00,994 --> 00:21:03,997
<c.magenta>如果你不这样做</c>

470
00:21:04,064 --> 00:21:06,466
<c.magenta>将会重复出现在更新交易回调之中</c>

471
00:21:06,533 --> 00:21:09,336
<c.magenta>直到你处理它并完结交易</c>

472
00:21:10,370 --> 00:21:13,006
<c.magenta>关于订阅结算重试</c>

473
00:21:13,073 --> 00:21:15,542
<c.magenta>如果你不使用自动续约订阅</c>

474
00:21:15,609 --> 00:21:17,845
<c.magenta>很重要的一点是</c>

475
00:21:17,911 --> 00:21:20,047
<c.magenta>这样 如果出现任何类型的结算错误</c>

476
00:21:20,113 --> 00:21:22,282
<c.magenta>我们的订阅结算重试逻辑</c>

477
00:21:22,349 --> 00:21:24,351
<c.magenta>可以继续尝试</c>

478
00:21:24,551 --> 00:21:26,053
<c.magenta>这一点很重要</c>

479
00:21:26,119 --> 00:21:28,455
<c.magenta>它让我们能够知道</c>

480
00:21:29,056 --> 00:21:31,758
<c.magenta>API是这样的</c>

481
00:21:31,825 --> 00:21:34,161
<c.magenta>在流程开始时</c>

482
00:21:34,228 --> 00:21:37,564
<c.magenta>可以将我们收到的交易对象</c>

483
00:21:37,631 --> 00:21:40,000
<c.magenta>传递给交易完结处理方法</c>

484
00:21:43,203 --> 00:21:45,973
<c.magenta>关于用户设备上的收条验证</c>

485
00:21:46,039 --> 00:21:48,275
<c.magenta>和内容更新流程就是这些</c>

486
00:21:48,342 --> 00:21:50,277
<c.magenta>让我们来看</c>

487
00:21:50,344 --> 00:21:51,778
<c.magenta>这是如何工作的</c>

488
00:21:52,145 --> 00:21:54,681
<c.magenta>为此 让我们来看一个例子</c>

489
00:21:56,250 --> 00:22:01,255
<c.magenta>假设有一个用户在使用你的程序</c>

490
00:21:56,250 --> 00:22:01,255
<c.magenta>假设有一个用户在使用你的程序</c>

491
00:22:01,321 --> 00:22:03,790
<c.magenta>而且你有一台服务器</c>

492
00:22:03,857 --> 00:22:06,393
<c.magenta>流程开始时</c>

493
00:22:06,460 --> 00:22:09,396
<c.magenta>接收交易</c>

494
00:22:09,463 --> 00:22:11,999
<c.magenta>然后 你使用前面所述的API</c>

495
00:22:12,065 --> 00:22:13,700
<c.magenta>读取二进制收条数据</c>

496
00:22:13,800 --> 00:22:16,170
<c.magenta>此时数据仍然经过编码</c>

497
00:22:16,236 --> 00:22:17,771
<c.magenta>进行检查</c>

498
00:22:17,838 --> 00:22:19,273
<c.magenta>与设备上的操作不同的是</c>

499
00:22:19,339 --> 00:22:23,644
<c.magenta>我们要做的是获取二进制编码收条数据</c>

500
00:22:24,945 --> 00:22:28,282
<c.magenta>然后 你可以</c>

501
00:22:28,348 --> 00:22:30,817
<c.magenta>建立与服务器之间的连接</c>

502
00:22:31,185 --> 00:22:33,287
<c.magenta>将二进制数据传输到</c>

503
00:22:33,353 --> 00:22:36,590
<c.magenta>现在App Store完成后续工作</c>

504
00:22:36,657 --> 00:22:38,258
<c.magenta>和验证所有相关信息</c>

505
00:22:38,325 --> 00:22:40,827
<c.magenta>并且返回收条有效性状态</c>

506
00:22:40,894 --> 00:22:43,897
<c.magenta>说明它是否是可信的文件</c>

507
00:22:45,632 --> 00:22:47,701
<c.magenta>这些处理工作使用文本格式</c>

508
00:22:47,768 --> 00:22:49,136
<c.magenta>回应信息位于JSON之中</c>

509
00:22:49,503 --> 00:22:53,040
<c.magenta>它返回一个状态</c>

510
00:22:53,106 --> 00:22:55,342
<c.magenta>但是这里需要指出的是</c>

511
00:22:55,542 --> 00:22:58,579
<c.magenta>不应该直接在用户设备上</c>

512
00:22:58,645 --> 00:23:00,047
<c.magenta>只有在你的服务器</c>

513
00:22:58,645 --> 00:23:00,047
<c.magenta>只有在你的服务器</c>

514
00:23:00,113 --> 00:23:01,748
<c.magenta>进行这些处理才是安全的</c>

515
00:23:04,685 --> 00:23:07,221
<c.magenta>应该在你的服务器上验证收条</c>

516
00:23:07,287 --> 00:23:09,823
<c.magenta>这比用户设备上的操作简单一些</c>

517
00:23:10,490 --> 00:23:12,559
<c.magenta>让我们来看</c>

518
00:23:12,626 --> 00:23:15,662
<c.magenta>你如何解锁内容</c>

519
00:23:18,065 --> 00:23:19,032
<c.magenta>让我们来再看这个例子</c>

520
00:23:19,099 --> 00:23:22,202
<c.magenta>假设你已经</c>

521
00:23:22,469 --> 00:23:24,972
<c.magenta>已经建立与App Store之间</c>

522
00:23:25,038 --> 00:23:26,940
<c.magenta>发送二进制数据到App Store</c>

523
00:23:27,641 --> 00:23:29,776
<c.magenta>不仅App Store</c>

524
00:23:29,843 --> 00:23:31,945
<c.magenta>返回收条的有效性状态</c>

525
00:23:32,346 --> 00:23:35,282
<c.magenta>而且这个回应信息</c>

526
00:23:35,349 --> 00:23:38,252
<c.magenta>最新程序收条的编码版本</c>

527
00:23:38,418 --> 00:23:41,321
<c.magenta>这是JSON中的解码版本</c>

528
00:23:41,388 --> 00:23:42,756
<c.magenta>所有交易信息</c>

529
00:23:42,823 --> 00:23:45,492
<c.magenta>与用户设备上的解密信息相同</c>

530
00:23:45,559 --> 00:23:48,462
<c.magenta>只是这次它们位于</c>

531
00:23:48,529 --> 00:23:50,864
<c.magenta>App Store发送的JSON数据负载之中</c>

532
00:23:50,931 --> 00:23:53,800
<c.magenta>决定是否解锁内容</c>

533
00:23:53,867 --> 00:23:57,037
<c.magenta>然后在用户设备上完结交易</c>

534
00:23:57,337 --> 00:23:59,406
<c.magenta>这特别有用</c>

535
00:23:59,473 --> 00:24:01,241
<c.magenta>在服务器关联的其它平台上</c>

536
00:23:59,473 --> 00:24:01,241
<c.magenta>在服务器关联的其它平台上</c>

537
00:24:01,308 --> 00:24:03,610
<c.magenta>更新状态</c>

538
00:24:04,678 --> 00:24:07,281
<c.magenta>流程就是这样的</c>

539
00:24:07,347 --> 00:24:09,583
<c.magenta>但是这里重要的一点是</c>

540
00:24:09,650 --> 00:24:11,952
<c.magenta>应该告诉设备</c>

541
00:24:12,019 --> 00:24:13,487
<c.magenta>仍然需要完结交易</c>

542
00:24:18,325 --> 00:24:21,762
<c.magenta>我们再次回答</c>

543
00:24:21,828 --> 00:24:24,097
<c.magenta>我的用户是否有</c>

544
00:24:24,831 --> 00:24:27,768
<c.magenta>这实际上是相同的流程</c>

545
00:24:27,835 --> 00:24:29,002
<c.magenta>此收条包含所有相同的信息</c>

546
00:24:29,069 --> 00:24:32,072
<c.magenta>你可以按照原始交易ID</c>

547
00:24:32,139 --> 00:24:35,843
<c.magenta>就是这个订阅ID字段</c>

548
00:24:36,009 --> 00:24:37,578
<c.magenta>你需要找到</c>

549
00:24:37,644 --> 00:24:39,379
<c.magenta>具有最近截止日期的交易</c>

550
00:24:39,446 --> 00:24:41,114
<c.magenta>如果截止日期是未来日期</c>

551
00:24:41,181 --> 00:24:44,618
<c.magenta>表示用户仍然存于有效订阅状态</c>

552
00:24:45,185 --> 00:24:46,520
<c.magenta>如果截止日期不是未来日期</c>

553
00:24:46,587 --> 00:24:47,754
<c.magenta>而是位于过去</c>

554
00:24:47,821 --> 00:24:50,791
<c.magenta>则意味着订阅已经过期</c>

555
00:24:51,091 --> 00:24:52,526
<c.magenta>这是收条的最新副本</c>

556
00:24:52,593 --> 00:24:55,395
<c.magenta>因此你不能在服务器上</c>

557
00:24:55,462 --> 00:24:58,131
<c.magenta>进行收条刷新请求</c>

558
00:24:59,433 --> 00:25:03,136
<c.magenta>现在 我们已经在这些信息基础上</c>

559
00:24:59,433 --> 00:25:03,136
<c.magenta>现在 我们已经在这些信息基础上</c>

560
00:25:03,203 --> 00:25:05,806
<c.magenta>前面我说过</c>

561
00:25:05,873 --> 00:25:07,241
<c.magenta>在用户设备上完结交易</c>

562
00:25:07,474 --> 00:25:09,676
<c.magenta>在本演讲中</c>

563
00:25:09,743 --> 00:25:12,412
<c.magenta>这是一个很重要的知识点</c>

564
00:25:13,981 --> 00:25:16,683
<c.magenta>现在让我们来详细讨论订阅</c>

565
00:25:16,750 --> 00:25:19,853
<c.magenta>这些方案已经应用</c>

566
00:25:20,087 --> 00:25:22,689
<c.magenta>接下来我们讨论维护订阅状态</c>

567
00:25:22,756 --> 00:25:25,292
<c.magenta>尤其是使用服务侧流程</c>

568
00:25:27,094 --> 00:25:28,996
<c.magenta>在本例中</c>

569
00:25:29,630 --> 00:25:33,433
<c.magenta>更新被发送到用户设备的交易调用</c>

570
00:25:33,500 --> 00:25:35,736
<c.magenta>用户可以读取二进制收条数据</c>

571
00:25:35,802 --> 00:25:37,337
<c.magenta>到用户设备的内存之中</c>

572
00:25:37,404 --> 00:25:40,307
<c.magenta>它们发送信息到你的服务器</c>

573
00:25:41,175 --> 00:25:43,410
<c.magenta>这次 我们准备使用稍微不同的技术</c>

574
00:25:43,477 --> 00:25:45,846
<c.magenta>这是一个现实世界例子</c>

575
00:25:45,913 --> 00:25:49,116
<c.magenta>我们将会在你的服务器上</c>

576
00:25:49,183 --> 00:25:52,686
<c.magenta>同时发送数据副本</c>

577
00:25:52,753 --> 00:25:55,489
<c.magenta>到App Store</c>

578
00:25:55,556 --> 00:25:57,991
<c.magenta>将会返回最近的收条副本</c>

579
00:25:58,058 --> 00:26:00,994
<c.magenta>我们可以使用同样的技术</c>

580
00:25:58,058 --> 00:26:00,994
<c.magenta>我们可以使用同样的技术</c>

581
00:26:01,061 --> 00:26:02,829
<c.magenta>完结交易和更新内容</c>

582
00:26:03,163 --> 00:26:07,634
<c.magenta>在本例中 我们处理</c>

583
00:26:07,701 --> 00:26:10,103
<c.magenta>假设用户离线一段时间</c>

584
00:26:10,170 --> 00:26:14,107
<c.magenta>停止使用你的应用几天</c>

585
00:26:14,174 --> 00:26:15,475
<c.magenta>可能会发生这样的情况</c>

586
00:26:15,542 --> 00:26:18,011
<c.magenta>如果发生这样的情况</c>

587
00:26:18,078 --> 00:26:21,048
<c.magenta>而且用户正好在此期间</c>

588
00:26:21,114 --> 00:26:22,549
<c.magenta>信用卡被扣费</c>

589
00:26:22,816 --> 00:26:25,018
<c.magenta>因此在某个地方发生新交易</c>

590
00:26:25,752 --> 00:26:26,620
<c.magenta>但是你并不知情</c>

591
00:26:26,687 --> 00:26:28,989
<c.magenta>然后用户重新连接到你的网站</c>

592
00:26:30,257 --> 00:26:32,659
<c.magenta>服务器并没有收到</c>

593
00:26:32,726 --> 00:26:35,562
<c.magenta>在后台发生的交易的任何信息</c>

594
00:26:36,029 --> 00:26:37,497
<c.magenta>为了从服务的角度</c>

595
00:26:37,564 --> 00:26:39,199
<c.magenta>获得这些信息</c>

596
00:26:39,833 --> 00:26:42,402
<c.magenta>我们在服务器上</c>

597
00:26:42,469 --> 00:26:44,638
<c.magenta>可以将数据视为令牌</c>

598
00:26:44,705 --> 00:26:46,940
<c.magenta>可以通过相同的请求</c>

599
00:26:47,007 --> 00:26:48,075
<c.magenta>将它发送回App Store</c>

600
00:26:49,743 --> 00:26:51,979
<c.magenta>前面我说过它不仅包含</c>

601
00:26:52,045 --> 00:26:53,013
<c.magenta>编码收条数据</c>

602
00:26:53,080 --> 00:26:56,216
<c.magenta>而且实际上是</c>

603
00:26:56,283 --> 00:26:59,186
<c.magenta>因此 这个最近副本将包含后台发生的</c>

604
00:26:59,253 --> 00:27:00,988
<c.magenta>任何新交易</c>

605
00:26:59,253 --> 00:27:00,988
<c.magenta>任何新交易</c>

606
00:27:01,054 --> 00:27:03,757
<c.magenta>你可以发现已经发生的交易</c>

607
00:27:03,824 --> 00:27:06,927
<c.magenta>而且相应地</c>

608
00:27:07,761 --> 00:27:10,631
<c.magenta>然后 你可能想要</c>

609
00:27:11,064 --> 00:27:13,166
<c.magenta>但你必须记住</c>

610
00:27:13,233 --> 00:27:15,802
<c.magenta>重新上线时</c>

611
00:27:16,170 --> 00:27:19,840
<c.magenta>将会通过更新交易调用</c>

612
00:27:20,140 --> 00:27:21,475
<c.magenta>对此你仍然需要进行处理</c>

613
00:27:21,542 --> 00:27:23,310
<c.magenta>而且应该完结交易</c>

614
00:27:23,377 --> 00:27:26,113
<c.magenta>我们建议应该将这作为一个机会</c>

615
00:27:26,180 --> 00:27:29,383
<c.magenta>在你的服务器上</c>

616
00:27:29,850 --> 00:27:32,219
<c.magenta>你可能想要</c>

617
00:27:32,286 --> 00:27:33,687
<c.magenta>为你程序关联用户的账户</c>

618
00:27:34,054 --> 00:27:35,722
<c.magenta>应该记住</c>

619
00:27:35,789 --> 00:27:36,790
<c.magenta>重新在设备上完结交易</c>

620
00:27:36,857 --> 00:27:39,126
<c.magenta>因此 即使你的服务器</c>

621
00:27:39,193 --> 00:27:40,928
<c.magenta>也应该完成这个流程</c>

622
00:27:40,994 --> 00:27:43,630
<c.magenta>并且按照前面所说的方法</c>

623
00:27:44,264 --> 00:27:46,200
<c.magenta>对于这项技术</c>

624
00:27:46,266 --> 00:27:48,769
<c.magenta>将收条数据视为令牌</c>

625
00:27:48,836 --> 00:27:50,871
<c.magenta>把它存储在你的服务器上</c>

626
00:27:50,938 --> 00:27:52,773
<c.magenta>用它来执行多个请求</c>

627
00:27:53,173 --> 00:27:56,210
<c.magenta>这些二进制数据</c>

628
00:27:57,411 --> 00:27:59,580
<c.magenta>可以用于在不同设备和平台上</c>

629
00:27:59,646 --> 00:28:01,481
<c.magenta>传播订阅状态</c>

630
00:27:59,646 --> 00:28:01,481
<c.magenta>传播订阅状态</c>

631
00:28:01,548 --> 00:28:04,351
<c.magenta>但是仍然要记住</c>

632
00:28:04,418 --> 00:28:06,019
<c.magenta>所有更新交易调用</c>

633
00:28:06,086 --> 00:28:07,821
<c.magenta>这意味着</c>

634
00:28:07,888 --> 00:28:10,257
<c.magenta>对于每个结算期的所有续约交易</c>

635
00:28:10,324 --> 00:28:12,526
<c.magenta>必须完结这些交易</c>

636
00:28:15,462 --> 00:28:17,464
<c.magenta>现在你可以想象</c>

637
00:28:17,531 --> 00:28:19,166
<c.magenta>如果你要处理</c>

638
00:28:19,233 --> 00:28:21,935
<c.magenta>尤其是 如果它具有较短的结算期</c>

639
00:28:22,002 --> 00:28:24,404
<c.magenta>这个交易收条可能变得很大</c>

640
00:28:24,471 --> 00:28:27,875
<c.magenta>所有订阅交易都会出现在收条上</c>

641
00:28:28,408 --> 00:28:30,811
<c.magenta>随着时间的推移</c>

642
00:28:31,211 --> 00:28:33,180
<c.magenta>我们听说 你们很多人</c>

643
00:28:33,247 --> 00:28:35,315
<c.magenta>只关心最近的交易</c>

644
00:28:35,382 --> 00:28:37,718
<c.magenta>前面我一直在说</c>

645
00:28:37,784 --> 00:28:40,153
<c.magenta>你们很多人仅关心最近的交易</c>

646
00:28:40,220 --> 00:28:44,091
<c.magenta>因此我们增强这个端点</c>

647
00:28:44,157 --> 00:28:48,462
<c.magenta>这个参数是</c>

648
00:28:48,762 --> 00:28:50,197
<c.magenta>如果将它设置为真</c>

649
00:28:51,498 --> 00:28:53,834
<c.magenta>验证收条端点将返回</c>

650
00:28:53,901 --> 00:28:56,503
<c.magenta>每个订阅的最近交易</c>

651
00:28:56,570 --> 00:28:59,306
<c.magenta>从而极大地减少</c>

652
00:28:59,373 --> 00:29:01,975
<c.magenta>从验证收条端点</c>

653
00:28:59,373 --> 00:29:01,975
<c.magenta>从验证收条端点</c>

654
00:29:02,042 --> 00:29:04,912
<c.magenta>不仅节省网络流量</c>

655
00:29:04,978 --> 00:29:07,814
<c.magenta>而且节省服务器处理时间</c>

656
00:29:07,881 --> 00:29:09,883
<c.magenta>因此不需要处理大量的交易数据</c>

657
00:29:09,950 --> 00:29:12,586
<c.magenta>看上去数据量并不多</c>

658
00:29:12,653 --> 00:29:14,955
<c.magenta>甚至百万计的用户请求</c>

659
00:29:15,022 --> 00:29:16,590
<c.magenta>将可以节省大量的时间</c>

660
00:29:16,657 --> 00:29:18,559
<c.magenta>对于处理这些应用的开发者来说</c>

661
00:29:18,625 --> 00:29:20,427
<c.magenta>这是极大的改进</c>

662
00:29:22,296 --> 00:29:24,264
<c.magenta>状态轮询技术…</c>

663
00:29:26,900 --> 00:29:27,734
<c.magenta>谢谢</c>

664
00:29:29,536 --> 00:29:33,040
<c.magenta>此技术十分适合于</c>

665
00:29:33,106 --> 00:29:35,876
<c.magenta>我们来看这张图</c>

666
00:29:36,376 --> 00:29:39,279
<c.magenta>你会注意到</c>

667
00:29:39,346 --> 00:29:41,415
<c.magenta>因为仍然很重要的一点是</c>

668
00:29:41,481 --> 00:29:45,352
<c.magenta>你需要在用户设备上</c>

669
00:29:48,021 --> 00:29:51,191
<c.magenta>我们来看订阅</c>

670
00:29:57,364 --> 00:30:01,401
<c.magenta>我们打开自动续约订阅</c>

671
00:29:57,364 --> 00:30:01,401
<c.magenta>我们打开自动续约订阅</c>

672
00:30:01,468 --> 00:30:03,971
<c.magenta>你们很多人都采用并且实现这个技术</c>

673
00:30:04,037 --> 00:30:05,339
<c.magenta>我们听到一些反馈意见</c>

674
00:30:05,606 --> 00:30:09,343
<c.magenta>我们尝试通过</c>

675
00:30:09,409 --> 00:30:12,079
<c.magenta>提供用户信息</c>

676
00:30:12,145 --> 00:30:14,381
<c.magenta>你可以发现</c>

677
00:30:14,448 --> 00:30:17,184
<c.magenta>但是你们有很多问题</c>

678
00:30:17,251 --> 00:30:19,553
<c.magenta>直到现在才能够得到解答</c>

679
00:30:20,020 --> 00:30:22,489
<c.magenta>特别是关于用户的问题</c>

680
00:30:22,556 --> 00:30:25,459
<c.magenta>比如 为何发生特定用户的订阅过期？</c>

681
00:30:25,526 --> 00:30:28,262
<c.magenta>将会在计费期结束时</c>

682
00:30:28,328 --> 00:30:29,997
<c.magenta>续约用户的订阅吗？</c>

683
00:30:31,098 --> 00:30:33,700
<c.magenta>在计费期末会降级用户吗？</c>

684
00:30:33,767 --> 00:30:35,068
<c.magenta>用户是否选择</c>

685
00:30:35,135 --> 00:30:37,538
<c.magenta>他们已有的订阅？</c>

686
00:30:38,405 --> 00:30:40,274
<c.magenta>他们是否已经请求</c>

687
00:30:40,340 --> 00:30:41,441
<c.magenta>其中的原因是什么？</c>

688
00:30:41,508 --> 00:30:44,745
<c.magenta>他们是否遇到问题</c>

689
00:30:45,279 --> 00:30:47,748
<c.magenta>他们是否同意我的涨价？</c>

690
00:30:48,148 --> 00:30:50,817
<c.magenta>他们会在计费期结束时终止订阅吗？</c>

691
00:30:50,884 --> 00:30:52,419
<c.magenta>我如何提前知道这些信息？</c>

692
00:30:52,486 --> 00:30:54,288
<c.magenta>或者更简单地</c>

693
00:30:54,354 --> 00:30:56,623
<c.magenta>我需要向用户告知</c>

694
00:30:56,690 --> 00:30:58,559
<c.magenta>如何有效地</c>

695
00:30:58,625 --> 00:31:01,495
<c.magenta>向他们告知这些信息</c>

696
00:30:58,625 --> 00:31:01,495
<c.magenta>向他们告知这些信息</c>

697
00:31:01,562 --> 00:31:03,730
<c.magenta>为什么所有这些问题都很重要呢？</c>

698
00:31:04,965 --> 00:31:07,501
<c.magenta>很明显 这是为了保证良好的用户体验</c>

699
00:31:07,568 --> 00:31:10,604
<c.magenta>这些问题之所以重要 是因为</c>

700
00:31:12,639 --> 00:31:15,409
<c.magenta>它们关系到</c>

701
00:31:15,475 --> 00:31:18,645
<c.magenta>用户是否会续约他们的订阅</c>

702
00:31:18,712 --> 00:31:22,249
<c.magenta>因此应该保证良好的用户体验</c>

703
00:31:22,316 --> 00:31:26,186
<c.magenta>必须尽量减少订阅障碍</c>

704
00:31:26,486 --> 00:31:29,256
<c.magenta>订阅障碍会导致订阅者减少</c>

705
00:31:29,356 --> 00:31:31,491
<c.magenta>当你失去订阅者时</c>

706
00:31:31,558 --> 00:31:33,594
<c.magenta>就会失去收入</c>

707
00:31:33,694 --> 00:31:35,596
<c.magenta>不仅会造成收入损失</c>

708
00:31:35,662 --> 00:31:38,832
<c.magenta>而且造成用户招揽成本损失</c>

709
00:31:39,967 --> 00:31:43,303
<c.magenta>我们可以从两个方面</c>

710
00:31:43,370 --> 00:31:45,739
<c.magenta>首先是非自主性障碍</c>

711
00:31:45,806 --> 00:31:48,809
<c.magenta>也就是说 用户并没有自主地退订</c>

712
00:31:48,876 --> 00:31:52,379
<c.magenta>比如信用卡过期</c>

713
00:31:52,813 --> 00:31:53,814
<c.magenta>现在…</c>

714
00:31:54,281 --> 00:31:56,783
<c.magenta>很多用户都属于这一种情况</c>

715
00:31:57,651 --> 00:31:59,319
<c.magenta>然后是自主性订阅障碍</c>

716
00:31:59,386 --> 00:32:02,723
<c.magenta>在这种情况下</c>

717
00:31:59,386 --> 00:32:02,723
<c.magenta>在这种情况下</c>

718
00:32:02,923 --> 00:32:04,925
<c.magenta>也许他们请求</c>

719
00:32:04,992 --> 00:32:07,661
<c.magenta>或者在设置中关闭续约</c>

720
00:32:08,829 --> 00:32:11,265
<c.magenta>我们想要为你们提供新工具</c>

721
00:32:11,331 --> 00:32:12,332
<c.magenta>以处理这两种障碍</c>

722
00:32:12,399 --> 00:32:14,434
<c.magenta>我们想到了一些很好的方法</c>

723
00:32:14,501 --> 00:32:18,138
<c.magenta>我们推出一些新工具</c>

724
00:32:18,338 --> 00:32:19,173
<c.magenta>让我们来看这些工具</c>

725
00:32:19,239 --> 00:32:21,642
<c.magenta>让我们来再看一个例子</c>

726
00:32:22,509 --> 00:32:25,479
<c.magenta>假设一个用户订阅你的服务</c>

727
00:32:25,546 --> 00:32:27,748
<c.magenta>这是一个视频订阅服务</c>

728
00:32:28,515 --> 00:32:31,018
<c.magenta>你使用状态轮询技术</c>

729
00:32:31,084 --> 00:32:34,821
<c.magenta>轮询App Store</c>

730
00:32:34,888 --> 00:32:37,090
<c.magenta>活跃用户</c>

731
00:32:37,157 --> 00:32:38,192
<c.magenta>的最新订阅状态</c>

732
00:32:38,725 --> 00:32:40,961
<c.magenta>然后用户离线几天</c>

733
00:32:41,962 --> 00:32:44,898
<c.magenta>在这段时间内</c>

734
00:32:44,965 --> 00:32:46,300
<c.magenta>这类似于前面的例子</c>

735
00:32:46,366 --> 00:32:49,536
<c.magenta>但是 这次我们假设</c>

736
00:32:49,603 --> 00:32:51,738
<c.magenta>App Store未能扣费</c>

737
00:32:51,972 --> 00:32:55,309
<c.magenta>因此发生结算错误</c>

738
00:32:55,375 --> 00:32:59,546
<c.magenta>进入你的网站</c>

739
00:32:59,613 --> 00:33:01,815
<c.magenta>这时 你的服务器</c>

740
00:32:59,613 --> 00:33:01,815
<c.magenta>这时 你的服务器</c>

741
00:33:01,882 --> 00:33:02,950
<c.magenta>使用前面讲过的状态轮询技术</c>

742
00:33:03,517 --> 00:33:06,753
<c.magenta>App Store将会告知</c>

743
00:33:06,820 --> 00:33:08,755
<c.magenta>因为发生了结算错误</c>

744
00:33:08,822 --> 00:33:10,657
<c.magenta>这时服务器</c>

745
00:33:10,724 --> 00:33:14,061
<c.magenta>将通知网站</c>

746
00:33:14,127 --> 00:33:16,063
<c.magenta>但这位可怜的用户</c>

747
00:33:16,129 --> 00:33:17,698
<c.magenta>他的信用卡过期了</c>

748
00:33:17,764 --> 00:33:20,234
<c.magenta>因此他更换信用卡</c>

749
00:33:20,300 --> 00:33:21,969
<c.magenta>在App Store上</c>

750
00:33:22,035 --> 00:33:23,103
<c.magenta>更新他的信用卡信息</c>

751
00:33:23,203 --> 00:33:25,172
<c.magenta>App Store</c>

752
00:33:25,239 --> 00:33:27,608
<c.magenta>成功进行扣费</c>

753
00:33:27,841 --> 00:33:30,043
<c.magenta>然后用户重新回到你的网站</c>

754
00:33:30,110 --> 00:33:32,679
<c.magenta>想要观看视频</c>

755
00:33:33,113 --> 00:33:34,014
<c.magenta>但是情况不妙</c>

756
00:33:34,948 --> 00:33:37,618
<c.magenta>这时你的服务器并不知道</c>

757
00:33:37,684 --> 00:33:39,953
<c.magenta>已经发生交易</c>

758
00:33:40,020 --> 00:33:42,256
<c.magenta>不知道信用卡已经扣费</c>

759
00:33:42,322 --> 00:33:44,958
<c.magenta>如果你是用户</c>

760
00:33:45,025 --> 00:33:47,561
<c.magenta>你想尽办法更新</c>

761
00:33:47,628 --> 00:33:50,397
<c.magenta>看到钱被划走</c>

762
00:33:50,464 --> 00:33:52,165
<c.magenta>但是你的订阅状态</c>

763
00:33:52,232 --> 00:33:53,567
<c.magenta>并没有更新</c>

764
00:33:53,967 --> 00:33:57,271
<c.magenta>你很可能会退订</c>

765
00:33:57,337 --> 00:33:59,339
<c.magenta>这种情况经常发生</c>

766
00:33:59,406 --> 00:34:01,508
<c.magenta>为了解决这个问题</c>

767
00:33:59,406 --> 00:34:01,508
<c.magenta>为了解决这个问题</c>

768
00:34:01,575 --> 00:34:04,645
<c.magenta>引入新的服务器-服务器通知</c>

769
00:34:10,150 --> 00:34:12,886
<c.magenta>让我们来看解决方案</c>

770
00:34:13,320 --> 00:34:15,489
<c.magenta>用户收到信息</c>

771
00:34:15,556 --> 00:34:16,723
<c.magenta>提示发生结算错误</c>

772
00:34:17,024 --> 00:34:19,458
<c.magenta>于是他们更新信用卡信息</c>

773
00:34:19,525 --> 00:34:21,495
<c.magenta>这次 利用新通知</c>

774
00:34:21,562 --> 00:34:24,364
<c.magenta>在App Store</c>

775
00:34:24,431 --> 00:34:26,766
<c.magenta>立即通知你的服务器</c>

776
00:34:26,833 --> 00:34:28,768
<c.magenta>告知发生了新交易</c>

777
00:34:28,835 --> 00:34:30,603
<c.magenta>你可以使用这个交易数据</c>

778
00:34:30,670 --> 00:34:32,505
<c.magenta>立即解锁用户</c>

779
00:34:32,572 --> 00:34:36,443
<c.magenta>让用户能够访问网站</c>

780
00:34:36,510 --> 00:34:39,012
<c.magenta>对于在服务器上</c>

781
00:34:39,079 --> 00:34:40,947
<c.magenta>这非常方便实用</c>

782
00:34:41,181 --> 00:34:42,315
<c.magenta>让我们来看</c>

783
00:34:42,382 --> 00:34:45,686
<c.magenta>你已获得</c>

784
00:34:45,752 --> 00:34:47,788
<c.magenta>你可以为服务器输入一个URL</c>

785
00:34:48,554 --> 00:34:49,590
<c.magenta>你的服务器不必</c>

786
00:34:49,656 --> 00:34:52,125
<c.magenta>遵守应用传输安全要求</c>

787
00:34:52,860 --> 00:34:55,629
<c.magenta>如果需要遵守安全要求</c>

788
00:34:55,963 --> 00:34:58,966
<c.magenta>可发送http端口到你的服务器</c>

789
00:34:59,032 --> 00:35:01,034
<c.magenta>我们发送的这些URL和端口</c>

790
00:34:59,032 --> 00:35:01,034
<c.magenta>我们发送的这些URL和端口</c>

791
00:35:01,134 --> 00:35:04,238
<c.magenta>它们用于任何初次订阅购买</c>

792
00:35:05,772 --> 00:35:07,941
<c.magenta>如果AppleCare取消订阅</c>

793
00:35:08,008 --> 00:35:10,644
<c.magenta>如果用户获得退款</c>

794
00:35:11,245 --> 00:35:13,013
<c.magenta>对于任何订阅降级</c>

795
00:35:13,080 --> 00:35:15,282
<c.magenta>因此任何时候</c>

796
00:35:15,349 --> 00:35:18,252
<c.magenta>相应地你可以在服务器上</c>

797
00:35:18,318 --> 00:35:19,686
<c.magenta>并更新订阅状态</c>

798
00:35:20,487 --> 00:35:23,690
<c.magenta>我们继续使用刚才的例子</c>

799
00:35:23,757 --> 00:35:25,726
<c.magenta>或重新购买已到期的订阅时</c>

800
00:35:25,792 --> 00:35:27,661
<c.magenta>可以立即解锁用户</c>

801
00:35:27,728 --> 00:35:29,630
<c.magenta>让他们能够访问订阅内容</c>

802
00:35:30,964 --> 00:35:33,834
<c.magenta>通知负载数据</c>

803
00:35:33,901 --> 00:35:36,603
<c.magenta>包括实际交易的</c>

804
00:35:36,670 --> 00:35:38,372
<c.magenta>最近交易数据</c>

805
00:35:39,206 --> 00:35:40,407
<c.magenta>因此 当你这样做时</c>

806
00:35:40,474 --> 00:35:44,077
<c.magenta>不需要像以前那样</c>

807
00:35:44,745 --> 00:35:47,381
<c.magenta>你可能仍然需要</c>

808
00:35:47,447 --> 00:35:50,050
<c.magenta>但是做法需要更聪明一些</c>

809
00:35:50,384 --> 00:35:53,453
<c.magenta>也许App Store通知</c>

810
00:35:53,687 --> 00:35:56,823
<c.magenta>你可能仍然需要</c>

811
00:35:56,890 --> 00:35:58,458
<c.magenta>订阅状态信息</c>

812
00:35:58,525 --> 00:36:00,494
<c.magenta>但是你可以做得更聪明一些</c>

813
00:35:58,525 --> 00:36:00,494
<c.magenta>但是你可以做得更聪明一些</c>

814
00:36:00,561 --> 00:36:04,231
<c.magenta>也许你可以在用户</c>

815
00:36:04,298 --> 00:36:06,767
<c.magenta>而不是每五钟查询一次</c>

816
00:36:07,534 --> 00:36:09,336
<c.magenta>这些功能将会于今年晚些时候发布</c>

817
00:36:09,403 --> 00:36:11,205
<c.magenta>我们认为这将会极大地</c>

818
00:36:11,271 --> 00:36:14,308
<c.magenta>减少用户可能遇到的订阅障碍</c>

819
00:36:17,778 --> 00:36:20,714
<c.magenta>让我们再来看刚才提到的问题</c>

820
00:36:21,515 --> 00:36:23,183
<c.magenta>新通知功能</c>

821
00:36:23,250 --> 00:36:24,952
<c.magenta>将使用我们刚才介绍的技术</c>

822
00:36:25,018 --> 00:36:26,353
<c.magenta>极大地减少订阅障碍</c>

823
00:36:26,420 --> 00:36:30,023
<c.magenta>但是我们还有很多信息</c>

824
00:36:31,525 --> 00:36:34,228
<c.magenta>尤其是有效期结束前的</c>

825
00:36:34,294 --> 00:36:37,564
<c.magenta>为了让你们能够访问这些信息</c>

826
00:36:37,631 --> 00:36:41,268
<c.magenta>今天我们宣布</c>

827
00:36:41,535 --> 00:36:42,669
<c.magenta>这些字段</c>

828
00:36:42,736 --> 00:36:44,371
<c.magenta>将为你提供</c>

829
00:36:44,438 --> 00:36:47,407
<c.magenta>用户信息和关键性</c>

830
00:36:47,474 --> 00:36:49,776
<c.magenta>因此如果用户</c>

831
00:36:49,843 --> 00:36:53,413
<c.magenta>你将会提前知道</c>

832
00:36:53,480 --> 00:36:54,414
<c.magenta>停止订阅</c>

833
00:36:54,481 --> 00:36:57,784
<c.magenta>也可以知道</c>

834
00:36:58,118 --> 00:36:59,987
<c.magenta>而不继续订阅</c>

835
00:37:00,053 --> 00:37:02,089
<c.magenta>因此你可以提前</c>

836
00:37:02,155 --> 00:37:05,058
<c.magenta>并且根据这些信息</c>

837
00:37:05,158 --> 00:37:07,094
<c.magenta>让我们来看加入的新字段</c>

838
00:37:08,262 --> 00:37:11,098
<c.magenta>这是相同的请求</c>

839
00:37:11,398 --> 00:37:13,333
<c.magenta>现在我们加入一个自动续约状态</c>

840
00:37:13,767 --> 00:37:17,271
<c.magenta>当用户选择关闭自动订阅续约时</c>

841
00:37:17,337 --> 00:37:18,939
<c.magenta>你可以在他们的订阅</c>

842
00:37:19,006 --> 00:37:21,508
<c.magenta>到期之前知道这一信息</c>

843
00:37:22,242 --> 00:37:24,178
<c.magenta>我们还加入一个自动续约设置</c>

844
00:37:24,344 --> 00:37:27,347
<c.magenta>如果用户选择降级</c>

845
00:37:27,414 --> 00:37:29,316
<c.magenta>你可以知道他们的操作</c>

846
00:37:29,383 --> 00:37:32,419
<c.magenta>并且了解特定付费期结束时的情况</c>

847
00:37:32,819 --> 00:37:34,454
<c.magenta>我们还加入价格同意状态</c>

848
00:37:34,521 --> 00:37:37,324
<c.magenta>如果你想对特定用户群</c>

849
00:37:37,391 --> 00:37:39,660
<c.magenta>你可以这样做</c>

850
00:37:39,726 --> 00:37:42,663
<c.magenta>也许80%的用户不同意提价</c>

851
00:37:42,729 --> 00:37:44,131
<c.magenta>他们可能会</c>

852
00:37:44,198 --> 00:37:45,399
<c.magenta>在付费期结束时退订</c>

853
00:37:45,465 --> 00:37:46,567
<c.magenta>在以前 你并不知道</c>

854
00:37:46,633 --> 00:37:48,035
<c.magenta>多少用户将会退订</c>

855
00:37:48,101 --> 00:37:50,637
<c.magenta>现在你可以根据这些信息</c>

856
00:37:50,737 --> 00:37:53,040
<c.magenta>也许你会决定不提价</c>

857
00:37:53,106 --> 00:37:55,475
<c.magenta>因为你可能会流失过多的订阅者</c>

858
00:37:57,211 --> 00:37:59,713
<c.magenta>我们还增加一个订阅结算重试标记</c>

859
00:38:00,013 --> 00:38:03,083
<c.magenta>当用户由于结算错误</c>

860
00:38:03,150 --> 00:38:06,420
<c.magenta>比如前面讲过的信用卡问题</c>

861
00:38:06,486 --> 00:38:09,823
<c.magenta>你可以看到用户将会具有此标记</c>

862
00:38:09,890 --> 00:38:13,293
<c.magenta>稍后我们将会演示</c>

863
00:38:14,461 --> 00:38:17,598
<c.magenta>另外还有终止原因</c>

864
00:38:17,664 --> 00:38:19,867
<c.magenta>是因为结算错误还是其它原因？</c>

865
00:38:19,933 --> 00:38:22,669
<c.magenta>现在你可以知道这些信息</c>

866
00:38:23,403 --> 00:38:25,539
<c.magenta>我们还加入取消原因</c>

867
00:38:25,906 --> 00:38:29,309
<c.magenta>在以前 如果用户</c>

868
00:38:29,376 --> 00:38:31,144
<c.magenta>你可能会猜想原因</c>

869
00:38:31,211 --> 00:38:34,815
<c.magenta>现在你可以知道用户是否</c>

870
00:38:34,882 --> 00:38:38,785
<c.magenta>还是因为某些个人原因</c>

871
00:38:40,020 --> 00:38:41,121
<c.magenta>让我们来看一些例子</c>

872
00:38:41,188 --> 00:38:43,190
<c.magenta>了解如何使用这些字段</c>

873
00:38:43,257 --> 00:38:45,492
<c.magenta>来消除或减少订阅障碍</c>

874
00:38:45,559 --> 00:38:47,961
<c.magenta>首先 让我们来看非自主性终止</c>

875
00:38:48,362 --> 00:38:51,598
<c.magenta>在这种情况下</c>

876
00:38:51,899 --> 00:38:54,801
<c.magenta>我们可以通过很多途径</c>

877
00:38:54,868 --> 00:38:57,604
<c.magenta>我们需要采取办法</c>

878
00:38:57,671 --> 00:39:01,408
<c.magenta>我们可以将重试付费时间延长为</c>

879
00:38:57,671 --> 00:39:01,408
<c.magenta>我们可以将重试付费时间延长为</c>

880
00:39:01,475 --> 00:39:03,076
<c.magenta>自现在起的60天</c>

881
00:39:03,477 --> 00:39:06,947
<c.magenta>在以前如果发生结算问题</c>

882
00:39:07,014 --> 00:39:09,449
<c.magenta>我们仅尝试</c>

883
00:39:09,516 --> 00:39:12,252
<c.magenta>现在我们延长到最多60天</c>

884
00:39:12,419 --> 00:39:15,656
<c.magenta>我们认为这可以挽回很多的退订</c>

885
00:39:16,223 --> 00:39:17,558
<c.magenta>在你们这边</c>

886
00:39:17,624 --> 00:39:19,493
<c.magenta>可以做很多事情来应对这些情况</c>

887
00:39:20,961 --> 00:39:23,463
<c.magenta>你可以使用终止原因字段</c>

888
00:39:23,530 --> 00:39:26,366
<c.magenta>和订阅重试标记</c>

889
00:39:26,767 --> 00:39:29,303
<c.magenta>我希望你们</c>

890
00:39:29,469 --> 00:39:32,306
<c.magenta>记住本演讲中的三个要点</c>

891
00:39:32,372 --> 00:39:34,608
<c.magenta>并且实施我将要讲述的三个步骤</c>

892
00:39:34,675 --> 00:39:37,678
<c.magenta>这样你将会极大地</c>

893
00:39:37,878 --> 00:39:41,949
<c.magenta>首先 你可以使用这两个字段</c>

894
00:39:42,049 --> 00:39:43,817
<c.magenta>如果你看到</c>

895
00:39:43,884 --> 00:39:46,787
<c.magenta>你可以告诉他们</c>

896
00:39:46,854 --> 00:39:47,921
<c.magenta>更新结算信息</c>

897
00:39:48,655 --> 00:39:49,723
<c.magenta>第二</c>

898
00:39:50,357 --> 00:39:52,659
<c.magenta>你可以为需要重试结算的用户</c>

899
00:39:52,726 --> 00:39:54,494
<c.magenta>继续提供经过降级的或暂时性的体验</c>

900
00:39:54,561 --> 00:39:56,663
<c.magenta>如果你看到他们需要重试结算</c>

901
00:39:56,730 --> 00:39:59,533
<c.magenta>也许你可以允许他们</c>

902
00:39:59,600 --> 00:40:00,901
<c.magenta>但是不能观看视频</c>

903
00:39:59,600 --> 00:40:00,901
<c.magenta>但是不能观看视频</c>

904
00:40:01,134 --> 00:40:04,238
<c.magenta>这就是为他们提供临时性的体验</c>

905
00:40:04,304 --> 00:40:07,975
<c.magenta>第三</c>

906
00:40:08,041 --> 00:40:11,745
<c.magenta>使用验证收条端点</c>

907
00:40:11,812 --> 00:40:13,981
<c.magenta>立即解锁用户</c>

908
00:40:14,448 --> 00:40:17,484
<c.magenta>这看上很容易理解</c>

909
00:40:17,551 --> 00:40:20,621
<c.magenta>如果你做好这三件事</c>

910
00:40:20,687 --> 00:40:23,624
<c.magenta>将可以挽回许多非自主性订阅终止</c>

911
00:40:25,092 --> 00:40:27,227
<c.magenta>对于自主性订阅终止</c>

912
00:40:27,294 --> 00:40:30,931
<c.magenta>当用户自主地选择退订时</c>

913
00:40:30,998 --> 00:40:33,467
<c.magenta>也可以使用这些信息</c>

914
00:40:33,767 --> 00:40:36,170
<c.magenta>现在我们加入一个终止原因字段</c>

915
00:40:36,236 --> 00:40:39,606
<c.magenta>你可以使用此字段</c>

916
00:40:40,140 --> 00:40:41,942
<c.magenta>假设一个用户取消订阅</c>

917
00:40:42,409 --> 00:40:45,479
<c.magenta>你可能会想</c>

918
00:40:46,213 --> 00:40:47,948
<c.magenta>你可能会降低价格</c>

919
00:40:48,015 --> 00:40:50,651
<c.magenta>用户仍然终止订阅</c>

920
00:40:50,717 --> 00:40:53,320
<c.magenta>你可以推出更有吸引力的选项</c>

921
00:40:53,387 --> 00:40:55,889
<c.magenta>因为你知道是价格原因</c>

922
00:40:55,956 --> 00:40:57,624
<c.magenta>导致用户退订</c>

923
00:40:57,691 --> 00:41:00,027
<c.magenta>在这些例子中 你已经了解</c>

924
00:40:57,691 --> 00:41:00,027
<c.magenta>在这些例子中 你已经了解</c>

925
00:41:00,093 --> 00:41:02,663
<c.magenta>如何使用这些字段</c>

926
00:41:02,729 --> 00:41:06,033
<c.magenta>帮助调整用户互动方式</c>

927
00:41:07,634 --> 00:41:09,403
<c.magenta>这些新字段和服务器通知</c>

928
00:41:09,469 --> 00:41:11,405
<c.magenta>将于今年末发布</c>

929
00:41:11,471 --> 00:41:14,775
<c.magenta>我们认为 这将会</c>

930
00:41:14,842 --> 00:41:17,678
<c.magenta>帮助你提高订阅量</c>

931
00:41:25,052 --> 00:41:28,956
<c.magenta>你还可以使用另一组工具</c>

932
00:41:29,022 --> 00:41:30,490
<c.magenta>进行服务端订阅管理</c>

933
00:41:30,557 --> 00:41:32,659
<c.magenta>和状态轮询</c>

934
00:41:32,926 --> 00:41:35,929
<c.magenta>当然 你仍然需要在用户设备上</c>

935
00:41:35,996 --> 00:41:38,565
<c.magenta>使用这个交易更新和完结流程</c>

936
00:41:39,867 --> 00:41:41,034
<c.magenta>我们讨论了订阅</c>

937
00:41:41,101 --> 00:41:43,237
<c.magenta>我还要简单讨论免费试用</c>

938
00:41:44,805 --> 00:41:47,107
<c.magenta>免费试用是指用户可以开始订阅</c>

939
00:41:47,174 --> 00:41:49,142
<c.magenta>但是不需要付款</c>

940
00:41:49,209 --> 00:41:52,579
<c.magenta>只有在免费期结束后</c>

941
00:41:53,614 --> 00:41:57,618
<c.magenta>我们看到过这样的复杂表格</c>

942
00:41:57,684 --> 00:42:00,254
<c.magenta>每个订阅周期</c>

943
00:41:57,684 --> 00:42:00,254
<c.magenta>每个订阅周期</c>

944
00:42:00,320 --> 00:42:01,855
<c.magenta>都有一定的免费试用期</c>

945
00:42:01,922 --> 00:42:04,391
<c.magenta>你必须根据</c>

946
00:42:04,458 --> 00:42:06,460
<c.magenta>选择免费试用期</c>

947
00:42:06,527 --> 00:42:09,263
<c.magenta>现在我们进行更改</c>

948
00:42:09,329 --> 00:42:11,832
<c.magenta>现在你可以为任何订阅周期</c>

949
00:42:11,899 --> 00:42:13,233
<c.magenta>设置任何免费试用期</c>

950
00:42:13,300 --> 00:42:15,435
<c.magenta>我们认为这是一项重要的改进</c>

951
00:42:15,502 --> 00:42:18,372
<c.magenta>这里也包括两个新免费试用期</c>

952
00:42:18,438 --> 00:42:20,574
<c.magenta>它们是三天试用期和两周试用期</c>

953
00:42:20,641 --> 00:42:23,644
<c.magenta>你可以为用户提供</c>

954
00:42:25,846 --> 00:42:27,748
<c.magenta>关于在服务器上维护订阅状态</c>

955
00:42:27,814 --> 00:42:29,816
<c.magenta>和管理自动续约订阅</c>

956
00:42:29,883 --> 00:42:30,884
<c.magenta>就是这些</c>

957
00:42:30,951 --> 00:42:34,221
<c.magenta>现在我想谈谈沙盒环境下的开发</c>

958
00:42:34,288 --> 00:42:37,224
<c.magenta>你们可以在开发时</c>

959
00:42:37,624 --> 00:42:38,992
<c.magenta>什么是沙盒？</c>

960
00:42:39,660 --> 00:42:42,329
<c.magenta>这并不是在用户设备上</c>

961
00:42:42,396 --> 00:42:45,465
<c.magenta>对你的程序使用沙盒</c>

962
00:42:45,532 --> 00:42:47,167
<c.magenta>这个特定的沙盒</c>

963
00:42:47,234 --> 00:42:51,271
<c.magenta>是我们提供给你们的测试环境</c>

964
00:42:51,505 --> 00:42:53,507
<c.magenta>在用于签名程序的证书基础上</c>

965
00:42:53,574 --> 00:42:55,576
<c.magenta>选择沙盒</c>

966
00:42:55,809 --> 00:42:58,612
<c.magenta>这样StoreKit就知道</c>

967
00:42:58,679 --> 00:43:01,114
<c.magenta>如果你在Xcode中</c>

968
00:42:58,679 --> 00:43:01,114
<c.magenta>如果你在Xcode中</c>

969
00:43:01,181 --> 00:43:02,983
<c.magenta>将使用你的开发者证书进行签名</c>

970
00:43:03,050 --> 00:43:06,320
<c.magenta>StoreKit知道它需要</c>

971
00:43:07,087 --> 00:43:09,389
<c.magenta>当然 若你使用App Store</c>

972
00:43:09,456 --> 00:43:12,059
<c.magenta>StoreKit就会知道</c>

973
00:43:12,125 --> 00:43:14,761
<c.magenta>与生产环境通信</c>

974
00:43:15,662 --> 00:43:17,030
<c.magenta>你如何知道</c>

975
00:43:17,097 --> 00:43:19,366
<c.magenta>当你开发应用时</c>

976
00:43:20,601 --> 00:43:23,103
<c.magenta>当你在你的应用中</c>

977
00:43:23,170 --> 00:43:26,240
<c.magenta>你获得这个新支付表格</c>

978
00:43:26,773 --> 00:43:29,109
<c.magenta>这表示你处于沙盒模式</c>

979
00:43:29,176 --> 00:43:30,878
<c.magenta>这告诉你</c>

980
00:43:30,944 --> 00:43:33,914
<c.magenta>将会发生沙盒支付</c>

981
00:43:33,981 --> 00:43:36,350
<c.magenta>并不会进行真正的付款</c>

982
00:43:37,951 --> 00:43:39,887
<c.magenta>沙盒与生产环境的主要区别</c>

983
00:43:39,953 --> 00:43:41,622
<c.magenta>当然也是最大的区别是</c>

984
00:43:41,688 --> 00:43:43,924
<c.magenta>这里不会发生真正的付款</c>

985
00:43:43,991 --> 00:43:45,959
<c.magenta>不会产生实际扣费</c>

986
00:43:46,026 --> 00:43:48,996
<c.magenta>并不会从你的信用卡</c>

987
00:43:49,062 --> 00:43:49,897
<c.magenta>扣取费用</c>

988
00:43:50,397 --> 00:43:51,798
<c.magenta>进行服务器到服务器验证时</c>

989
00:43:51,865 --> 00:43:53,700
<c.magenta>有一个不同的端点</c>

990
00:43:53,767 --> 00:43:56,703
<c.magenta>我们为验证收条端点</c>

991
00:43:57,104 --> 00:43:59,706
<c.magenta>你还可以在沙盒环境中</c>

992
00:43:59,773 --> 00:44:03,110
<c.magenta>以不同的方式进行处理</c>

993
00:43:59,773 --> 00:44:03,110
<c.magenta>以不同的方式进行处理</c>

994
00:44:03,977 --> 00:44:04,978
<c.magenta>另一个不同点是</c>

995
00:44:05,045 --> 00:44:08,215
<c.magenta>可自动续约订阅的时间约束</c>

996
00:44:08,348 --> 00:44:10,951
<c.magenta>因此 你不必等待一整年</c>

997
00:44:11,018 --> 00:44:14,388
<c.magenta>以测试你的方案</c>

998
00:44:14,454 --> 00:44:17,257
<c.magenta>缩略规则是沙盒中的一小时</c>

999
00:44:17,324 --> 00:44:19,660
<c.magenta>相当于现实世界中的一年</c>

1000
00:44:19,726 --> 00:44:21,595
<c.magenta>这就是沙盒中的</c>

1001
00:44:21,662 --> 00:44:24,031
<c.magenta>各种不同订阅时间比例关系</c>

1002
00:44:25,165 --> 00:44:26,099
<c.magenta>当你处于沙盒环境中</c>

1003
00:44:26,166 --> 00:44:27,835
<c.magenta>我们做的另一件事情是</c>

1004
00:44:27,901 --> 00:44:30,838
<c.magenta>如果你订阅一个自动续约订阅服务</c>

1005
00:44:30,904 --> 00:44:35,375
<c.magenta>每八小时窗口的</c>

1006
00:44:36,476 --> 00:44:37,811
<c.magenta>然后就会过期</c>

1007
00:44:37,878 --> 00:44:41,114
<c.magenta>因此你会遇到用户订阅过期的情况</c>

1008
00:44:41,181 --> 00:44:44,084
<c.magenta>然后在你的应用中</c>

1009
00:44:45,552 --> 00:44:47,487
<c.magenta>在设置这种测试环境时</c>

1010
00:44:47,554 --> 00:44:49,323
<c.magenta>将通过iTunes Connect</c>

1011
00:44:49,423 --> 00:44:51,358
<c.magenta>你在iTunes Connect中</c>

1012
00:44:51,425 --> 00:44:52,993
<c.magenta>然后使用已经准备开始销售的</c>

1013
00:44:53,060 --> 00:44:54,628
<c.magenta>程序内购买产品</c>

1014
00:44:54,695 --> 00:44:57,064
<c.magenta>然后使用Xcode生成</c>

1015
00:44:57,130 --> 00:44:59,867
<c.magenta>使用开发者证书</c>

1016
00:44:59,933 --> 00:45:02,302
<c.magenta>然后在你的应用内</c>

1017
00:44:59,933 --> 00:45:02,302
<c.magenta>然后在你的应用内</c>

1018
00:45:02,369 --> 00:45:03,971
<c.magenta>当提示你登录时</c>

1019
00:45:04,037 --> 00:45:06,473
<c.magenta>你能使用在iTunes Connect中</c>

1020
00:45:06,540 --> 00:45:08,141
<c.magenta>进行登录</c>

1021
00:45:08,909 --> 00:45:10,944
<c.magenta>请注意</c>

1022
00:45:11,378 --> 00:45:13,146
<c.magenta>你需要在Finder中</c>

1023
00:45:13,213 --> 00:45:16,116
<c.magenta>以确保取回收条</c>

1024
00:45:16,550 --> 00:45:19,286
<c.magenta>这是因为前面</c>

1025
00:45:19,353 --> 00:45:23,090
<c.magenta>在Mac计算机上</c>

1026
00:45:23,156 --> 00:45:25,292
<c.magenta>如果你首次在Xcode中</c>

1027
00:45:25,359 --> 00:45:28,228
<c.magenta>你需要确保在Finder中</c>

1028
00:45:28,295 --> 00:45:31,899
<c.magenta>使StoreKit能够捕获</c>

1029
00:45:33,433 --> 00:45:34,868
<c.magenta>对于在服务器上使用沙盒</c>

1030
00:45:34,935 --> 00:45:36,937
<c.magenta>前面我说过</c>

1031
00:45:37,004 --> 00:45:38,972
<c.magenta>提供一个不同的端点</c>

1032
00:45:39,039 --> 00:45:40,707
<c.magenta>在开发环境中</c>

1033
00:45:40,774 --> 00:45:42,910
<c.magenta>你们将具有</c>

1034
00:45:42,976 --> 00:45:44,945
<c.magenta>可能与测试服务器通信</c>

1035
00:45:45,012 --> 00:45:47,381
<c.magenta>测试服务器</c>

1036
00:45:47,447 --> 00:45:48,749
<c.magenta>与App Store沙盒通信</c>

1037
00:45:49,583 --> 00:45:50,884
<c.magenta>在生产中</c>

1038
00:45:50,951 --> 00:45:53,687
<c.magenta>你的生产应用</c>

1039
00:45:53,754 --> 00:45:56,056
<c.magenta>然后与生产App Store</c>

1040
00:45:56,123 --> 00:45:59,159
<c.magenta>但是在特定情况下</c>

1041
00:45:59,860 --> 00:46:01,962
<c.magenta>这是当你的应用处于应用审查状态时</c>

1042
00:45:59,860 --> 00:46:01,962
<c.magenta>这是当你的应用处于应用审查状态时</c>

1043
00:46:02,963 --> 00:46:03,931
<c.magenta>为什么不匹配？</c>

1044
00:46:03,997 --> 00:46:07,267
<c.magenta>因为应用审查团队</c>

1045
00:46:07,334 --> 00:46:09,570
<c.magenta>测试你的程序内购买</c>

1046
00:46:09,970 --> 00:46:10,871
<c.magenta>因此看上去是这样的</c>

1047
00:46:10,938 --> 00:46:14,608
<c.magenta>你的生产签名应用</c>

1048
00:46:14,675 --> 00:46:16,910
<c.magenta>但是你需要检查</c>

1049
00:46:17,277 --> 00:46:19,847
<c.magenta>以通过应用审查</c>

1050
00:46:19,913 --> 00:46:22,349
<c.magenta>那么 如何处理这种不匹配？</c>

1051
00:46:22,583 --> 00:46:24,251
<c.magenta>我们提供一个方法</c>

1052
00:46:25,052 --> 00:46:27,321
<c.magenta>首先 当你处于生产环境中时</c>

1053
00:46:28,121 --> 00:46:30,891
<c.magenta>请首先尝试生产</c>

1054
00:46:31,325 --> 00:46:33,026
<c.magenta>如果收条是用于沙盒环境的</c>

1055
00:46:33,093 --> 00:46:36,230
<c.magenta>你将收到一个错误代码21007</c>

1056
00:46:36,630 --> 00:46:41,268
<c.magenta>这表示你需要</c>

1057
00:46:41,335 --> 00:46:43,437
<c.magenta>因此你可以将收条</c>

1058
00:46:43,504 --> 00:46:46,106
<c.magenta>这意味着你的应用</c>

1059
00:46:46,173 --> 00:46:47,608
<c.magenta>而不会发生问题</c>

1060
00:46:49,576 --> 00:46:52,179
<c.magenta>在新的服务器到服务器通知方面</c>

1061
00:46:52,246 --> 00:46:53,447
<c.magenta>处理方法略有不同</c>

1062
00:46:53,514 --> 00:46:57,251
<c.magenta>在iTunes Connect中</c>

1063
00:46:57,317 --> 00:46:58,886
<c.magenta>或用于你自己的测试服务器</c>

1064
00:46:59,720 --> 00:47:03,657
<c.magenta>我们使用通知的实际数据负载中的</c>

1065
00:46:59,720 --> 00:47:03,657
<c.magenta>我们使用通知的实际数据负载中的</c>

1066
00:47:03,724 --> 00:47:06,360
<c.magenta>有一个环境键值</c>

1067
00:47:06,426 --> 00:47:10,197
<c.magenta>告诉你通知</c>

1068
00:47:10,264 --> 00:47:12,099
<c.magenta>还是用于生产环境中的订阅</c>

1069
00:47:14,001 --> 00:47:15,969
<c.magenta>关于沙盒环境下的开发就是这些</c>

1070
00:47:16,036 --> 00:47:19,439
<c.magenta>今天我们讲了很多的内容</c>

1071
00:47:19,573 --> 00:47:21,341
<c.magenta>让我们进行回顾</c>

1072
00:47:21,408 --> 00:47:23,377
<c.magenta>我们详细讨论了收条验证</c>

1073
00:47:23,443 --> 00:47:26,246
<c.magenta>如何在用户设备上验证</c>

1074
00:47:26,313 --> 00:47:29,216
<c.magenta>以确保真实性</c>

1075
00:47:29,550 --> 00:47:32,152
<c.magenta>然后讨论了</c>

1076
00:47:32,219 --> 00:47:33,320
<c.magenta>维护订阅状态</c>

1077
00:47:33,387 --> 00:47:37,257
<c.magenta>如何更新设备</c>

1078
00:47:37,958 --> 00:47:40,928
<c.magenta>我们引入新的通知功能</c>

1079
00:47:40,994 --> 00:47:43,997
<c.magenta>以解锁用户</c>

1080
00:47:44,064 --> 00:47:46,500
<c.magenta>为用户提供更好的体验</c>

1081
00:47:47,134 --> 00:47:48,902
<c.magenta>我们还引入新的收条字段</c>

1082
00:47:48,969 --> 00:47:51,839
<c.magenta>可以根据用户的交易信息</c>

1083
00:47:51,905 --> 00:47:55,275
<c.magenta>做出更好的业务决策</c>

1084
00:47:55,542 --> 00:47:58,111
<c.magenta>请记住三个简单的步骤</c>

1085
00:47:58,278 --> 00:47:59,847
<c.magenta>这三个步骤帮助你取得成功</c>

1086
00:48:00,247 --> 00:48:03,350
<c.magenta>如果你完成这三个步骤</c>

1087
00:48:03,417 --> 00:48:05,085
<c.magenta>将会为你挽回大量的非自主性退订</c>

1088
00:48:05,152 --> 00:48:06,520
<c.magenta>今年末这些新字段开始启用后</c>

1089
00:48:06,587 --> 00:48:08,455
<c.magenta>请执行这些步骤</c>

1090
00:48:08,522 --> 00:48:10,490
<c.magenta>最后我们讨论了沙盒开发</c>

1091
00:48:10,557 --> 00:48:13,093
<c.magenta>你能够在沙盒环境中</c>

1092
00:48:13,160 --> 00:48:14,962
<c.magenta>有关本演讲的更多信息</c>

1093
00:48:15,028 --> 00:48:18,398
<c.magenta>请观看幻灯片</c>

1094
00:48:18,465 --> 00:48:20,734
<c.magenta>可以在开发者网站上</c>

1095
00:48:21,335 --> 00:48:23,737
<c.magenta>本周我们举行了一些相关的演讲</c>

1096
00:48:23,804 --> 00:48:25,105
<c.magenta>现在快到周末了</c>

1097
00:48:25,205 --> 00:48:28,041
<c.magenta>今天下午我们仍然会在这里</c>

1098
00:48:28,108 --> 00:48:30,677
<c.magenta>这里有整个企业的客户端和</c>

1099
00:48:30,744 --> 00:48:33,814
<c.magenta>服务器端的工程师</c>

1100
00:48:33,881 --> 00:48:34,882
<c.magenta>聚集在StoreKit实验室</c>

1101
00:48:34,948 --> 00:48:36,783
<c.magenta>今天下午和明天下午</c>

1102
00:48:36,850 --> 00:48:39,753
<c.magenta>欢迎大家前来提问</c>

1103
00:48:39,820 --> 00:48:40,921
<c.magenta>我们将解答你们的问题</c>

1104
00:48:40,988 --> 00:48:43,624
<c.magenta>并且讨论</c>

1105
00:48:43,857 --> 00:48:45,659
<c.magenta>感谢大家今天来参加演讲</c>

1106
00:48:45,726 --> 00:48:47,261
<c.magenta>谢谢大家 下午过得愉快</c>
